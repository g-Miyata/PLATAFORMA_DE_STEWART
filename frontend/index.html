<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stewart Platform - IFSP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
        padding: 30px 20px;
      }
      .container {
        max-width: 1600px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 24px;
        border-bottom: 1px solid #e5e7eb;
      }
      h1 {
        color: #111827;
        margin-bottom: 8px;
        font-size: 2.5em;
        font-weight: 700;
        letter-spacing: -0.02em;
      }
      .subtitle-header {
        color: #6b7280;
        font-size: 1em;
        font-weight: 500;
      }
      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }
      .panel {
        background: #ffffff;
        padding: 28px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
      }
      .section-title {
        color: #111827;
        margin-bottom: 24px;
        font-size: 1.25em;
        font-weight: 600;
        text-align: left;
      }
      .input-group {
        margin-bottom: 20px;
      }
      .input-group h3 {
        color: #374151;
        font-size: 0.875em;
        margin-bottom: 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .input-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
      }
      .input-field {
        display: flex;
        flex-direction: column;
      }
      label {
        color: #6b7280;
        font-weight: 500;
        margin-bottom: 6px;
        font-size: 0.875em;
      }
      input[type='number'] {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.95em;
        transition: all 0.2s;
        background: #f9fafb;
      }
      input[type='number']:focus {
        outline: none;
        border-color: #2f9e41;
        background: #ffffff;
        box-shadow: 0 0 0 3px rgba(47, 158, 65, 0.1);
      }
      .slider-container {
        margin-top: 8px;
      }
      input[type='range'] {
        width: 100%;
        height: 4px;
        border-radius: 2px;
        background: #e5e7eb;
        outline: none;
        appearance: none;
      }
      input[type='range']::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #2f9e41;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      input[type='range']::-webkit-slider-thumb:hover {
        background: #1a6b2d;
        transform: scale(1.1);
      }
      input[type='range']::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #2f9e41;
        border: none;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      input[type='range']::-moz-range-thumb:hover {
        background: #1a6b2d;
        transform: scale(1.1);
      }
      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
      }
      button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      }
      .btn-primary {
        background: #2f9e41;
        color: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .btn-primary:hover {
        background: #1a6b2d;
        box-shadow: 0 4px 12px rgba(47, 158, 65, 0.3);
        transform: translateY(-1px);
      }
      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .btn-secondary:hover {
        background: #e5e7eb;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
      }
      .status-indicator {
        padding: 16px;
        border-radius: 10px;
        text-align: center;
        font-weight: 600;
        font-size: 0.95em;
        margin-bottom: 24px;
        border: 1px solid;
      }
      .status-valid {
        background: #ecfdf5;
        color: #065f46;
        border-color: #10b981;
      }
      .status-invalid {
        background: #fef2f2;
        color: #991b1b;
        border-color: #ef4444;
      }
      .actuators-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
      .actuator-card {
        background: #ffffff;
        padding: 14px;
        border-radius: 10px;
        border: 1px solid;
        text-align: center;
        transition: all 0.2s;
      }
      .actuator-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .actuator-valid {
        border-color: #10b981;
        background: #f0fdf4;
      }
      .actuator-invalid {
        border-color: #ef4444;
        background: #fef2f2;
      }
      .actuator-id {
        font-weight: 600;
        color: #111827;
        margin-bottom: 6px;
        font-size: 0.875em;
      }
      .actuator-length {
        color: #6b7280;
        font-size: 0.875em;
      }
      .actuator-percentage {
        margin-top: 8px;
        font-weight: 600;
        font-size: 0.95em;
      }
      .percentage-valid {
        color: #059669;
      }
      .percentage-invalid {
        color: #dc2626;
      }
      .canvas-container {
        width: 100%;
        height: 420px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: linear-gradient(135deg, #0f172a, #1e293b);
        position: relative;
        overflow: hidden;
        margin-top: 16px;
      }
      #canvas-preview,
      #canvas-live {
        width: 100%;
        height: 100%;
      }
      .controls-3d,
      .legend {
        position: absolute;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(8px);
        color: #f1f5f9;
        padding: 12px;
        border-radius: 8px;
        font-size: 11px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        z-index: 10;
      }
      .controls-3d {
        top: 10px;
        right: 10px;
      }
      .legend {
        bottom: 10px;
        left: 10px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
      }
      .legend-color {
        width: 12px;
        height: 12px;
        margin-right: 8px;
        border-radius: 2px;
      }
      .loading {
        display: none;
        text-align: center;
        color: #2f9e41;
        font-style: italic;
        margin-top: 6px;
        font-weight: 600;
      }
      .error-message {
        display: none;
        background: #fef2f2;
        color: #991b1b;
        padding: 12px;
        border-radius: 8px;
        margin-top: 12px;
        border: 1px solid #ef4444;
        font-size: 0.875em;
      }
      .two-canvases {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .subtitle {
        font-weight: 600;
        text-align: center;
        color: #374151;
        padding: 10px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        font-size: 0.875em;
      }
      .btn-reset-cam {
        background: rgba(47, 158, 65, 0.9);
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 10px;
        transition: all 0.2s;
        font-weight: 500;
      }
      .btn-reset-cam:hover {
        background: #2f9e41;
        box-shadow: 0 2px 8px rgba(47, 158, 65, 0.3);
      }
      @media (max-width: 1024px) {
        .main-content {
          grid-template-columns: 1fr;
        }
        .input-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üîß Stewart Platform</h1>
        <div class="subtitle-header">Instituto Federal de S√£o Paulo</div>
      </div>

      <div class="main-content">
        <div class="panel">
          <h2 class="section-title">Controles de Posi√ß√£o</h2>

          <div class="input-group">
            <h3>Transla√ß√£o (mm)</h3>
            <div class="input-row">
              <div class="input-field">
                <label for="x-pos">X</label>
                <input type="number" id="x-pos" value="0" min="-50" max="50" step="1" />
                <div class="slider-container"><input type="range" id="x-slider" min="-50" max="50" value="0" step="1" /></div>
              </div>
              <div class="input-field">
                <label for="y-pos">Y</label>
                <input type="number" id="y-pos" value="0" min="-50" max="50" step="1" />
                <div class="slider-container"><input type="range" id="y-slider" min="-50" max="50" value="0" step="1" /></div>
              </div>
              <div class="input-field">
                <label for="z-pos">Z</label>
                <input type="number" id="z-pos" value="432" min="200" max="600" step="1" />
                <div class="slider-container"><input type="range" id="z-slider" min="200" max="600" value="432" step="1" /></div>
              </div>
            </div>
          </div>

          <div class="input-group">
            <h3>Rota√ß√£o (graus)</h3>
            <div class="input-row">
              <div class="input-field">
                <label for="roll">Roll</label>
                <input type="number" id="roll" value="0" min="-15" max="15" step="0.1" />
                <div class="slider-container"><input type="range" id="roll-slider" min="-15" max="15" value="0" step="0.1" /></div>
              </div>
              <div class="input-field">
                <label for="pitch">Pitch</label>
                <input type="number" id="pitch" value="0" min="-15" max="15" step="0.1" />
                <div class="slider-container"><input type="range" id="pitch-slider" min="-15" max="15" value="0" step="0.1" /></div>
              </div>
              <div class="input-field">
                <label for="yaw">Yaw</label>
                <input type="number" id="yaw" value="0" min="-15" max="15" step="0.1" />
                <div class="slider-container"><input type="range" id="yaw-slider" min="-15" max="15" value="0" step="0.1" /></div>
              </div>
            </div>
          </div>

          <div class="button-group">
            <button class="btn-primary" id="btn-calc">Calcular Posi√ß√£o</button>
            <button class="btn-secondary" id="btn-reset">Resetar</button>
          </div>

          <div class="loading" id="loading">Calculando‚Ä¶</div>
          <div class="error-message" id="error-message"></div>
        </div>

        <div class="panel">
          <h2 class="section-title">Visualiza√ß√£o 3D</h2>

          <div class="two-canvases">
            <div>
              <div class="subtitle">Preview (Simulada)</div>
              <div class="canvas-container">
                <div id="canvas-preview"></div>
                <div class="controls-3d">
                  <div>üñ±Ô∏è Rotacionar | üñ≤Ô∏è Zoom | Ctrl+Mouse: Pan</div>
                  <div style="margin-top: 8px">
                    <button id="btn-reset-cam-prev" class="btn-reset-cam">Reset View</button>
                  </div>
                </div>
                <div class="legend">
                  <div class="legend-item">
                    <div class="legend-color" style="background: #cd191e"></div>
                    <span>Base</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background: #2f9e41"></div>
                    <span>Plataforma</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background: #50c878"></div>
                    <span>Atuador OK</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background: #ff4444"></div>
                    <span>Atuador Inv√°lido</span>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <div class="subtitle">Live (WebSocket)</div>
              <div class="canvas-container">
                <div id="canvas-live"></div>
                <div class="controls-3d">
                  <div>üñ±Ô∏è Rotacionar | üñ≤Ô∏è Zoom | Ctrl+Mouse: Pan</div>
                  <div style="margin-top: 8px">
                    <button id="btn-reset-cam-live" class="btn-reset-cam">Reset View</button>
                  </div>
                </div>
                <div class="legend">
                  <div class="legend-item">
                    <div class="legend-color" style="background: #cd191e"></div>
                    <span>Base</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background: #2f9e41"></div>
                    <span>Plataforma</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background: #50c878"></div>
                    <span>Atuador OK</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color" style="background: #ff4444"></div>
                    <span>Atuador Inv√°lido</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="status-indicator" id="status-indicator">Pressione "Calcular Posi√ß√£o" para come√ßar</div>
      <div class="actuators-grid" id="actuators-grid"></div>
    </div>

    <script>
      const API_BASE = 'http://localhost:8001';
      const WS_URL = 'ws://localhost:8001/ws/telemetry';
      let currentPlatformData = null;
      window.__threeScenes = {};

      function setupInputSync() {
        const inputs = ['x-pos', 'y-pos', 'z-pos', 'roll', 'pitch', 'yaw'];
        const sliders = ['x-slider', 'y-slider', 'z-slider', 'roll-slider', 'pitch-slider', 'yaw-slider'];
        inputs.forEach((id, i) => {
          const input = document.getElementById(id);
          const slider = document.getElementById(sliders[i]);
          if (!input || !slider) return;
          input.addEventListener('input', () => {
            slider.value = input.value;
          });
          slider.addEventListener('input', () => {
            input.value = slider.value;
          });
        });
      }

      function getPoseFromUI() {
        return {
          x: parseFloat(document.getElementById('x-pos').value),
          y: parseFloat(document.getElementById('y-pos').value),
          z: parseFloat(document.getElementById('z-pos').value),
          roll: parseFloat(document.getElementById('roll').value),
          pitch: parseFloat(document.getElementById('pitch').value),
          yaw: parseFloat(document.getElementById('yaw').value),
        };
      }

      function setStatus(valid) {
        const el = document.getElementById('status-indicator');
        if (valid) {
          el.className = 'status-indicator status-valid';
          el.textContent = '‚úÖ Posi√ß√£o V√ÅLIDA - Todos os atuadores dentro dos limites';
        } else {
          el.className = 'status-indicator status-invalid';
          el.textContent = '‚ùå Posi√ß√£o INV√ÅLIDA - Alguns atuadores fora dos limites';
        }
      }

      function updateActuatorCards(actuators) {
        const grid = document.getElementById('actuators-grid');
        grid.innerHTML = '';
        (actuators || []).forEach((a) => {
          const card = document.createElement('div');
          card.className = `actuator-card ${a.valid ? 'actuator-valid' : 'actuator-invalid'}`;
          card.innerHTML = `
          <div class="actuator-id">Atuador ${a.id}</div>
          <div class="actuator-length">${Number(a.length).toFixed(1)} mm</div>
          <div class="actuator-percentage ${a.valid ? 'percentage-valid' : 'percentage-invalid'}">${Number(a.percentage).toFixed(1)}%</div>
        `;
          grid.appendChild(card);
        });
      }

      const COLORS = {
        base: 0xcd191e,
        platform: 0x2f9e41,
        actuatorValid: 0x50c878,
        actuatorInvalid: 0xff4444,
        background: 0x0f172a,
        grid: 0x475569,
      };

      function init3D(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(COLORS.background);

        const width = container.offsetWidth || 600;
        const height = container.offsetHeight || 420;
        const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 2000);
        camera.position.set(500, 500, 500);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        let controls = null;
        if (typeof THREE.OrbitControls !== 'undefined') {
          controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true;
          controls.dampingFactor = 0.05;
          controls.target.set(0, 200, 0);
        }

        scene.add(new THREE.AmbientLight(0x404040, 0.6));
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(200, 300, 200);
        dir.castShadow = true;
        scene.add(dir);

        const grid = new THREE.GridHelper(600, 30, COLORS.grid, COLORS.grid);
        grid.position.y = -50;
        scene.add(grid);

        const baseGroup = new THREE.Group();
        const platformGroup = new THREE.Group();
        const actuatorGroup = new THREE.Group();
        scene.add(baseGroup, platformGroup, actuatorGroup);

        function onResize() {
          const w = container.offsetWidth || 600;
          const h = container.offsetHeight || 420;
          camera.aspect = w / h;
          camera.updateProjectionMatrix();
          renderer.setSize(w, h);
        }
        window.addEventListener('resize', onResize);

        function animate() {
          requestAnimationFrame(animate);
          if (controls) controls.update();
          renderer.render(scene, camera);
        }
        animate();

        window.__threeScenes[containerId] = { scene, camera, renderer, controls, baseGroup, platformGroup, actuatorGroup };
      }

      function createBasePoint(position) {
        const g = new THREE.Group();
        const sph = new THREE.Mesh(new THREE.SphereGeometry(8, 16, 16), new THREE.MeshPhongMaterial({ color: COLORS.base }));
        sph.castShadow = true;
        g.add(sph);
        g.position.set(position[0], position[2] || 0, position[1]);
        return g;
      }

      function createPlatformPoint(position) {
        const g = new THREE.Group();
        const sph = new THREE.Mesh(new THREE.SphereGeometry(6, 16, 16), new THREE.MeshPhongMaterial({ color: COLORS.platform }));
        sph.castShadow = true;
        g.add(sph);
        g.position.set(position[0], position[2], position[1]);
        return g;
      }

      function createActuator(startPos, endPos, actuator) {
        const g = new THREE.Group();
        const start = new THREE.Vector3(startPos[0], startPos[2] || 0, startPos[1]);
        const end = new THREE.Vector3(endPos[0], endPos[2], endPos[1]);
        const length = start.distanceTo(end);
        const cyl = new THREE.Mesh(new THREE.CylinderGeometry(3, 3, length, 8), new THREE.MeshPhongMaterial({ color: actuator.valid ? COLORS.actuatorValid : COLORS.actuatorInvalid }));
        const mid = start.clone().add(end).multiplyScalar(0.5);
        cyl.position.copy(mid);
        cyl.lookAt(end);
        cyl.rotateX(Math.PI / 2);
        cyl.castShadow = true;
        g.add(cyl);
        return g;
      }

      function draw3DPlatform(containerId, data) {
        const ctx = window.__threeScenes[containerId];
        if (!ctx) return;
        const { scene, controls, baseGroup, platformGroup, actuatorGroup } = ctx;

        baseGroup.clear();
        platformGroup.clear();
        actuatorGroup.clear();

        const bs = data.base_points;
        const baseShape = new THREE.Shape();
        baseShape.moveTo(bs[0][0], bs[0][1]);
        for (let i = 1; i < bs.length; i++) baseShape.lineTo(bs[i][0], bs[i][1]);
        baseShape.closePath();
        const baseGeo = new THREE.ShapeGeometry(baseShape);
        const baseMat = new THREE.MeshPhongMaterial({ color: COLORS.base, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
        const baseSurf = new THREE.Mesh(baseGeo, baseMat);
        baseSurf.rotation.x = -Math.PI / 2;
        baseSurf.position.y = -5;
        baseSurf.receiveShadow = true;
        baseGroup.add(baseSurf);

        const baseEdges = new THREE.EdgesGeometry(baseGeo);
        const baseWire = new THREE.LineSegments(baseEdges, new THREE.LineBasicMaterial({ color: COLORS.base }));
        baseWire.rotation.x = -Math.PI / 2;
        baseWire.position.y = -4;
        baseGroup.add(baseWire);

        bs.forEach((p) => baseGroup.add(createBasePoint(p)));

        const verts = [],
          idx = [];
        const ps = data.platform_points;
        ps.forEach((p) => verts.push(p[0], p[2], p[1]));
        let cx = 0,
          cy = 0,
          cz = 0;
        ps.forEach((p) => {
          cx += p[0];
          cy += p[2];
          cz += p[1];
        });
        cx /= ps.length;
        cy /= ps.length;
        cz /= ps.length;
        verts.push(cx, cy, cz);
        const cIndex = ps.length;
        for (let i = 0; i < ps.length; i++) {
          const n = (i + 1) % ps.length;
          idx.push(i, n, cIndex);
        }

        const platGeo = new THREE.BufferGeometry();
        platGeo.setIndex(idx);
        platGeo.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
        platGeo.computeVertexNormals();
        const platMat = new THREE.MeshPhongMaterial({ color: COLORS.platform, transparent: true, opacity: 0.7, side: THREE.DoubleSide });
        const platSurf = new THREE.Mesh(platGeo, platMat);
        platSurf.castShadow = true;
        platSurf.receiveShadow = true;
        platformGroup.add(platSurf);

        const edgeVerts = [];
        for (let i = 0; i < ps.length; i++) {
          const p = ps[i];
          edgeVerts.push(p[0], p[2], p[1]);
        }
        const p0 = ps[0];
        edgeVerts.push(p0[0], p0[2], p0[1]);
        const edgeGeo = new THREE.BufferGeometry();
        edgeGeo.setAttribute('position', new THREE.Float32BufferAttribute(edgeVerts, 3));
        const edgeLine = new THREE.Line(edgeGeo, new THREE.LineBasicMaterial({ color: 0x1a6b2d }));
        platformGroup.add(edgeLine);

        ps.forEach((p) => platformGroup.add(createPlatformPoint(p)));

        (data.actuators || []).forEach((a, i) => {
          actuatorGroup.add(createActuator(bs[i], ps[i], a));
        });

        if (controls) {
          const h = ps[0][2] || 432;
          controls.target.set(0, h / 2, 0);
        }
      }

      function resetCamera(containerId) {
        const ctx = window.__threeScenes[containerId];
        if (!ctx) return;
        const { camera, controls } = ctx;
        const h = (currentPlatformData && currentPlatformData.platform_points?.[0]?.[2]) || 432;
        camera.position.set(500, h + 200, 500);
        if (controls) {
          controls.target.set(0, h / 2, 0);
          controls.update();
        }
      }

      async function calculatePosition() {
        const loading = document.getElementById('loading');
        const errBox = document.getElementById('error-message');
        try {
          loading.style.display = 'block';
          errBox.style.display = 'none';
          const pose = getPoseFromUI();
          const resp = await fetch(`${API_BASE}/calculate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pose),
          });
          if (!resp.ok) throw new Error(`Erro ${resp.status}: ${resp.statusText}`);
          const data = await resp.json();
          currentPlatformData = data;

          setStatus(data.valid);
          updateActuatorCards(data.actuators);
          draw3DPlatform('canvas-preview', data);
        } catch (e) {
          console.error(e);
          errBox.textContent = `Erro: ${e.message}`;
          errBox.style.display = 'block';
        } finally {
          loading.style.display = 'none';
        }
      }

      function resetPosition() {
        document.getElementById('x-pos').value = 0;
        document.getElementById('y-pos').value = 0;
        document.getElementById('z-pos').value = 432;
        document.getElementById('roll').value = 0;
        document.getElementById('pitch').value = 0;
        document.getElementById('yaw').value = 0;
        document.getElementById('x-slider').value = 0;
        document.getElementById('y-slider').value = 0;
        document.getElementById('z-slider').value = 432;
        document.getElementById('roll-slider').value = 0;
        document.getElementById('pitch-slider').value = 0;
        document.getElementById('yaw-slider').value = 0;
        calculatePosition();
      }

      let ws = null,
        wsTimer = null;

      function normalizeTelemetry(msg) {
        const out = {};
        if (msg.pose) out.pose = msg.pose;
        if (msg.base_points) out.base_points = msg.base_points;
        if (msg.platform_points) out.platform_points = msg.platform_points;
        if (typeof msg.valid === 'boolean') out.valid = msg.valid;

        if (msg.actuators) {
          out.actuators = msg.actuators.map((a, i) => ({
            id: a.id ?? i + 1,
            length: Number(a.length ?? 0),
            percentage: Number(a.percentage ?? 0),
            valid: Boolean(a.valid ?? true),
          }));
        } else if (Array.isArray(msg.lengths)) {
          out.actuators = msg.lengths.map((L, i) => ({
            id: i + 1,
            length: Number(L),
            percentage: Array.isArray(msg.percentages) ? Number(msg.percentages[i] ?? 0) : 0,
            valid: true,
          }));
        }

        return out;
      }

      function applyLiveTelemetry(data) {
        if (data.base_points && data.platform_points) {
          if (typeof data.valid !== 'boolean' && Array.isArray(data.actuators)) {
            data.valid = data.actuators.every((a) => a.valid !== false);
          }
          setStatus(Boolean(data.valid));
          if (Array.isArray(data.actuators)) updateActuatorCards(data.actuators);
          draw3DPlatform('canvas-live', data);
        } else if (Array.isArray(data.actuators)) {
          setStatus(data.actuators.every((a) => a.valid !== false));
          updateActuatorCards(data.actuators);
          if (currentPlatformData && currentPlatformData.base_points && currentPlatformData.platform_points) {
            const merged = {
              base_points: currentPlatformData.base_points,
              platform_points: currentPlatformData.platform_points,
              actuators: data.actuators,
              valid: data.actuators.every((a) => a.valid !== false),
            };
            draw3DPlatform('canvas-live', merged);
          }
        }
      }

      function initTelemetryWS() {
        if (ws) {
          try {
            ws.close();
          } catch (_) {}
          ws = null;
        }
        try {
          ws = new WebSocket(WS_URL);
        } catch (e) {
          console.error('[WS] erro ao criar WebSocket:', e);
          scheduleReconnect();
          return;
        }

        ws.onopen = () => {
          console.log('[WS] conectado');
        };
        ws.onclose = () => {
          console.warn('[WS] desconectado');
          scheduleReconnect();
        };
        ws.onerror = (e) => {
          console.error('[WS] erro', e);
        };

        ws.onmessage = (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            const data = normalizeTelemetry(msg);
            applyLiveTelemetry(data);
          } catch (e) {
            console.error('[WS] mensagem inv√°lida', e, evt.data);
          }
        };
      }

      function scheduleReconnect() {
        if (wsTimer) clearTimeout(wsTimer);
        wsTimer = setTimeout(() => {
          initTelemetryWS();
        }, 1000);
      }

      window.addEventListener('DOMContentLoaded', () => {
        setupInputSync();
        init3D('canvas-preview');
        init3D('canvas-live');
        document.getElementById('btn-calc').addEventListener('click', calculatePosition);
        document.getElementById('btn-reset').addEventListener('click', resetPosition);
        document.getElementById('btn-reset-cam-prev').addEventListener('click', () => resetCamera('canvas-preview'));
        document.getElementById('btn-reset-cam-live').addEventListener('click', () => resetCamera('canvas-live'));
        calculatePosition();
      });
    </script>
  </body>
</html>

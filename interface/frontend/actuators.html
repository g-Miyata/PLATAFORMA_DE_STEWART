<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plataforma de Stewart - Controle</title>
    <link rel="icon" type="image/svg+xml" href="./assets/ifsp.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
      .console-line {
        padding: 2px 0;
        font-family: 'Courier New', monospace;
        font-size: 13px;
      }
      .console-rx {
        color: #10b981;
      }
      .console-tx {
        color: #3b82f6;
      }
      .console-info {
        color: #6b7280;
      }
      .pulse-dot {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <!-- Header -->
      <div class="bg-gray-800 rounded-2xl shadow-sm p-8 mb-6 border border-gray-700">
        <div class="text-center">
          <h1 class="text-4xl font-bold text-white mb-2">Plataforma de Stewart - Controle</h1>
          <div class="flex justify-center items-center gap-2">
            <img src="./assets/ifsp.svg" alt="logo IFSP" class="w-6" />
            <p class="text-gray-300">Instituto Federal de S√£o Paulo</p>
          </div>
        </div>
      </div>

      <!-- Navega√ß√£o -->
      <div class="bg-gray-800 rounded-2xl shadow-sm p-4 mb-6 border border-gray-700">
        <div class="flex flex-wrap gap-2 justify-center">
          <a href="index.html" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg transition-colors font-medium">üè† In√≠cio</a>
          <a href="kinematics.html" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg transition-colors font-medium">üìê Cinem√°tica</a>
          <a href="actuators.html" class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold">üéÆ Controle</a>
          <a href="settings.html" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg transition-colors font-medium">‚öôÔ∏è Configura√ß√µes</a>
        </div>
      </div>

      <!-- Conex√£o Serial -->
      <div class="bg-gray-800 rounded-2xl shadow-sm p-6 mb-6 border border-gray-700">
        <h2 class="text-xl font-semibold text-white mb-4">Conex√£o Serial</h2>
        <div class="flex flex-wrap gap-4 items-end">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-300 mb-2">Porta Serial</label>
            <select id="serial-port" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-green-500">
              <option value="">Selecione...</option>
            </select>
          </div>
          <button onclick="refreshPorts()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors font-medium">‚Üª Atualizar</button>
          <button id="btn-connect" onclick="connectSerial()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-semibold">Conectar</button>
          <button id="btn-disconnect" onclick="disconnectSerial()" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-semibold hidden">Desconectar</button>
        </div>
        <div id="serial-status" class="mt-4 px-4 py-3 rounded-lg bg-red-50 border border-red-200">
          <span class="text-red-800 font-medium">‚õî Desconectado</span>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Console -->
        <div class="bg-gray-800 rounded-2xl shadow-sm p-6 border border-gray-700">
          <h2 class="text-xl font-semibold text-white mb-4">üìü Console RX/TX</h2>
          <div id="console" class="bg-gray-900 rounded-lg p-4 h-96 overflow-y-auto text-sm text-gray-300 font-mono">
            <div class="console-info">Aguardando conex√£o...</div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">Comando Livre</label>
            <div class="flex gap-2">
              <input id="free-command" type="text" placeholder="Digite comando..." class="flex-1 px-4 py-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" onkeypress="if(event.key==='Enter') sendFreeCommand()" />
              <button onclick="sendFreeCommand()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-semibold">Enviar</button>
            </div>
          </div>
        </div>

        <!-- Telemetria -->
        <div class="bg-gray-800 rounded-2xl shadow-sm p-6 border border-gray-700">
          <h2 class="text-xl font-semibold text-gray-300 mb-4">üìä Telemetria em Tempo Real</h2>
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-300">Setpoint Global (mm):</span>
              <span id="telem-sp" class="text-lg font-bold text-green-400">--</span>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-gradient-to-br from-gray-700 to-gray-600 rounded-lg p-4 border border-blue-500">
              <div class="text-xs font-semibold text-blue-400 mb-1">Pist√£o 1</div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-300">Y:</span>
                <span id="telem-y1" class="font-bold text-white">--</span>
              </div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-sm text-gray-300">PWM:</span>
                <span id="telem-pwm1" class="font-bold text-white">--</span>
              </div>
            </div>
            <div class="bg-gradient-to-br from-gray-700 to-gray-600 rounded-lg p-4 border border-purple-500">
              <div class="text-xs font-semibold text-purple-400 mb-1">Pist√£o 2</div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-300">Y:</span>
                <span id="telem-y2" class="font-bold text-white">--</span>
              </div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-sm text-gray-300">PWM:</span>
                <span id="telem-pwm2" class="font-bold text-white">--</span>
              </div>
            </div>
            <div class="bg-gradient-to-br from-gray-700 to-gray-600 rounded-lg p-4 border border-pink-500">
              <div class="text-xs font-semibold text-pink-400 mb-1">Pist√£o 3</div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-300">Y:</span>
                <span id="telem-y3" class="font-bold text-white">--</span>
              </div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-sm text-gray-300">PWM:</span>
                <span id="telem-pwm3" class="font-bold text-white">--</span>
              </div>
            </div>
            <div class="bg-gradient-to-br from-gray-700 to-gray-600 rounded-lg p-4 border border-orange-500">
              <div class="text-xs font-semibold text-orange-400 mb-1">Pist√£o 4</div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-300">Y:</span>
                <span id="telem-y4" class="font-bold text-white">--</span>
              </div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-sm text-gray-300">PWM:</span>
                <span id="telem-pwm4" class="font-bold text-white">--</span>
              </div>
            </div>
            <div class="bg-gradient-to-br from-gray-700 to-gray-600 rounded-lg p-4 border border-teal-500">
              <div class="text-xs font-semibold text-teal-400 mb-1">Pist√£o 5</div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-300">Y:</span>
                <span id="telem-y5" class="font-bold text-white">--</span>
              </div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-sm text-gray-300">PWM:</span>
                <span id="telem-pwm5" class="font-bold text-white">--</span>
              </div>
            </div>
            <div class="bg-gradient-to-br from-gray-700 to-gray-600 rounded-lg p-4 border border-indigo-500">
              <div class="text-xs font-semibold text-indigo-400 mb-1">Pist√£o 6</div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-300">Y:</span>
                <span id="telem-y6" class="font-bold text-white">--</span>
              </div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-sm text-gray-300">PWM:</span>
                <span id="telem-pwm6" class="font-bold text-white">--</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Setpoints -->
      <div class="bg-gray-800 rounded-2xl shadow-sm p-6 mt-6 border border-gray-700">
        <h2 class="text-xl font-semibold text-white mb-4">üéØ Setpoints (mm)</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Setpoint Global (aplicar em todos)</label>
            <div class="flex gap-2">
              <input id="sp-global" type="number" step="0.1" value="0" class="flex-1 px-4 py-2 text-white bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" />
              <button onclick="sendSetpointGlobal()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-semibold whitespace-nowrap">Aplicar em Todos</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-6">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Pist√£o 1</label>
            <div class="flex gap-2">
              <input id="sp-1" type="number" step="0.1" value="0" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
              <button onclick="sendSetpointInd(1)" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium">‚úì</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Pist√£o 2</label>
            <div class="flex gap-2">
              <input id="sp-2" type="number" step="0.1" value="0" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
              <button onclick="sendSetpointInd(2)" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium">‚úì</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Pist√£o 3</label>
            <div class="flex gap-2">
              <input id="sp-3" type="number" step="0.1" value="0" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" />
              <button onclick="sendSetpointInd(3)" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg transition-colors font-medium">‚úì</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Pist√£o 4</label>
            <div class="flex gap-2">
              <input id="sp-4" type="number" step="0.1" value="0" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
              <button onclick="sendSetpointInd(4)" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors font-medium">‚úì</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Pist√£o 5</label>
            <div class="flex gap-2">
              <input id="sp-5" type="number" step="0.1" value="0" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" />
              <button onclick="sendSetpointInd(5)" class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg transition-colors font-medium">‚úì</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Pist√£o 6</label>
            <div class="flex gap-2">
              <input id="sp-6" type="number" step="0.1" value="0" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
              <button onclick="sendSetpointInd(6)" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium">‚úì</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Link para Configura√ß√µes -->
      <div class="bg-gray-800 rounded-2xl shadow-sm p-6 mt-6 border border-gray-700">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-semibold text-gray-300 mb-2">‚öôÔ∏è Ganhos PID e Configura√ß√µes</h2>
            <p class="text-gray-400">Configure os ganhos PID de cada pist√£o e ajustes gerais do sistema</p>
          </div>
          <a href="settings.html" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-semibold whitespace-nowrap">Ir para Configura√ß√µes ‚Üí</a>
        </div>
      </div>

      <!-- Controle Manual -->
      <div class="rounded-2xl shadow-sm p-6 mt-6 bg-gray-800 border border-gray-700">
        <h2 class="text-xl font-semibold text-white mb-4">üïπÔ∏è Controle Manual</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Selecionar Pist√£o</label>
            <div class="flex gap-2">
              <select id="manual-piston" class="flex-1 px-4 py-2 border border-gray-600 bg-gray-800 text-white rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="1">Pist√£o 1</option>
                <option value="2">Pist√£o 2</option>
                <option value="3">Pist√£o 3</option>
                <option value="4">Pist√£o 4</option>
                <option value="5">Pist√£o 5</option>
                <option value="6">Pist√£o 6</option>
              </select>
              <button onclick="selectPiston()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-semibold">Selecionar</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">A√ß√µes</label>
            <div class="flex gap-2">
              <button onclick="manualAdvance()" class="flex-1 px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-semibold">‚ñ≤ Avan√ßo</button>
              <button onclick="manualRetract()" class="flex-1 px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors font-semibold">‚ñº Recuo</button>
              <button onclick="manualStop()" class="flex-1 px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-semibold">‚èπ Parar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center text-gray-400 text-sm mt-8">
        <p>
          üí° Dica: Use comandos como
          <code class="bg-gray-700 px-2 py-1 rounded text-green-400">spmm=100</code>
          para setpoint global ou
          <code class="bg-gray-700 px-2 py-1 rounded text-green-400">spmm1=50</code>
          para individual
        </p>
      </div>
    </div>

    <script>
      const API_BASE = 'http://localhost:8001';
      const WS_URL = 'ws://localhost:8001/ws/telemetry';
      let ws = null;
      let reconnectTimer = null;
      let isConnected = false;

      // ========== Console ==========
      function logConsole(text, type = 'info') {
        const console = document.getElementById('console');
        const line = document.createElement('div');
        line.className = `console-line console-${type}`;

        const timestamp = new Date().toLocaleTimeString('pt-BR');
        const prefix = type === 'tx' ? '‚Üí TX' : type === 'rx' ? '‚Üê RX' : '  ';
        line.textContent = `[${timestamp}] ${prefix}: ${text}`;

        console.appendChild(line);
        console.scrollTop = console.scrollHeight;

        // Limita a 500 linhas
        while (console.children.length > 500) {
          console.removeChild(console.firstChild);
        }
      }

      // ========== Serial Connection ==========
      async function refreshPorts() {
        try {
          const res = await fetch(`${API_BASE}/serial/ports`);
          const data = await res.json();
          const select = document.getElementById('serial-port');
          select.innerHTML = '<option value="">Selecione...</option>';
          data.ports.forEach((port) => {
            const opt = document.createElement('option');
            opt.value = port;
            opt.textContent = port;
            select.appendChild(opt);
          });
          logConsole('Portas atualizadas', 'info');
        } catch (err) {
          logConsole(`Erro ao listar portas: ${err.message}`, 'info');
        }
      }

      async function connectSerial() {
        const port = document.getElementById('serial-port').value;
        if (!port) {
          alert('Selecione uma porta serial');
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/serial/open`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ port, baud: 115200 }),
          });
          const data = await res.json();

          if (res.ok) {
            isConnected = true;
            document.getElementById('btn-connect').classList.add('hidden');
            document.getElementById('btn-disconnect').classList.remove('hidden');
            document.getElementById('serial-status').className = 'mt-4 px-4 py-3 rounded-lg bg-green-50 border border-green-200';
            document.getElementById('serial-status').innerHTML = '<span class="text-green-800 font-medium">‚úÖ Conectado em ' + port + '</span>';
            logConsole(`Conectado em ${port}`, 'info');

            // Salvar estado no localStorage
            localStorage.setItem('serial_connected', 'true');
            localStorage.setItem('serial_port', port);

            initWebSocket();
          } else {
            throw new Error(data.detail || 'Erro ao conectar');
          }
        } catch (err) {
          logConsole(`Erro: ${err.message}`, 'info');
          alert(`Erro: ${err.message}`);
        }
      }

      async function disconnectSerial() {
        try {
          await fetch(`${API_BASE}/serial/close`, { method: 'POST' });
          isConnected = false;
          document.getElementById('btn-connect').classList.remove('hidden');
          document.getElementById('btn-disconnect').classList.add('hidden');
          document.getElementById('serial-status').className = 'mt-4 px-4 py-3 rounded-lg bg-red-50 border border-red-200';
          document.getElementById('serial-status').innerHTML = '<span class="text-red-800 font-medium">‚õî Desconectado</span>';
          logConsole('Desconectado', 'info');

          // Limpar estado no localStorage
          localStorage.setItem('serial_connected', 'false');
          localStorage.removeItem('serial_port');

          if (ws) {
            ws.close();
            ws = null;
          }
        } catch (err) {
          logConsole(`Erro ao desconectar: ${err.message}`, 'info');
        }
      }

      // ========== WebSocket ==========
      function initWebSocket() {
        if (ws) {
          ws.close();
        }

        console.log('üîå Conectando WebSocket:', WS_URL);
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
          console.log('‚úÖ WebSocket conectado!');
          logConsole('WebSocket conectado', 'info');
          clearTimeout(reconnectTimer);
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleTelemetry(data);
          } catch (err) {
            console.error('‚ùå Erro ao processar mensagem WS:', err, event.data);
          }
        };

        ws.onerror = (err) => {
          console.error('‚ùå WebSocket error:', err);
        };

        ws.onclose = () => {
          console.log('üîå WebSocket desconectado');
          logConsole('WebSocket desconectado', 'info');
          if (isConnected) {
            reconnectTimer = setTimeout(initWebSocket, 2000);
          }
        };
      }

      function handleTelemetry(data) {
        // üêõ DEBUG: Log de todas as mensagens recebidas
        console.log('üì° WebSocket recebeu:', data);

        if (data.type === 'raw') {
          logConsole(data.raw, 'rx');
        } else if (data.type === 'telemetry' && data.Y) {
          // Atualiza telemetria (backend envia sp_mm, n√£o SP)
          document.getElementById('telem-sp').textContent = data.sp_mm?.toFixed(2) || '--';
          for (let i = 0; i < 6; i++) {
            document.getElementById(`telem-y${i + 1}`).textContent = data.Y[i]?.toFixed(2) || '--';
            document.getElementById(`telem-pwm${i + 1}`).textContent = data.PWM[i]?.toFixed(0) || '--';
          }
          console.log('‚úÖ Telemetria atualizada na UI');
        }
      }

      // ========== Commands ==========
      async function sendCommand(cmd) {
        if (!isConnected) {
          alert('Conecte √† porta serial primeiro');
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/serial/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: cmd }),
          });
          const data = await res.json();
          if (res.ok) {
            logConsole(cmd, 'tx');
          } else {
            throw new Error(data.detail || 'Erro ao enviar');
          }
        } catch (err) {
          logConsole(`Erro: ${err.message}`, 'info');
        }
      }

      function sendFreeCommand() {
        const cmd = document.getElementById('free-command').value.trim();
        if (!cmd) return;
        sendCommand(cmd);
        document.getElementById('free-command').value = '';
      }

      // ========== Setpoints ==========
      async function sendSetpointGlobal() {
        const value = parseFloat(document.getElementById('sp-global').value);
        try {
          const res = await fetch(`${API_BASE}/pid/setpoint`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ piston: null, value }),
          });
          const data = await res.json();
          if (res.ok) {
            logConsole(`Setpoint global: ${value} mm`, 'tx');
          }
        } catch (err) {
          logConsole(`Erro: ${err.message}`, 'info');
        }
      }

      async function sendSetpointInd(piston) {
        const value = parseFloat(document.getElementById(`sp-${piston}`).value);
        try {
          const res = await fetch(`${API_BASE}/pid/setpoint`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ piston, value }),
          });
          const data = await res.json();
          if (res.ok) {
            logConsole(`Setpoint pist√£o ${piston}: ${value} mm`, 'tx');
          }
        } catch (err) {
          logConsole(`Erro: ${err.message}`, 'info');
        }
      }

      // ========== Manual Control ==========
      async function selectPiston() {
        const piston = parseInt(document.getElementById('manual-piston').value);
        try {
          const res = await fetch(`${API_BASE}/pid/select/${piston}`, {
            method: 'POST',
          });
          const data = await res.json();
          if (res.ok) {
            logConsole(`Pist√£o ${piston} selecionado`, 'tx');
          }
        } catch (err) {
          logConsole(`Erro: ${err.message}`, 'info');
        }
      }

      async function manualAdvance() {
        try {
          const res = await fetch(`${API_BASE}/pid/manual/A`, { method: 'POST' });
          if (res.ok) {
            logConsole('Manual: Avan√ßo (A)', 'tx');
          }
        } catch (err) {
          logConsole(`Erro: ${err.message}`, 'info');
        }
      }

      async function manualRetract() {
        try {
          const res = await fetch(`${API_BASE}/pid/manual/R`, { method: 'POST' });
          if (res.ok) {
            logConsole('Manual: Recuo (R)', 'tx');
          }
        } catch (err) {
          logConsole(`Erro: ${err.message}`, 'info');
        }
      }

      async function manualStop() {
        try {
          const res = await fetch(`${API_BASE}/pid/manual/ok`, { method: 'POST' });
          if (res.ok) {
            logConsole('Manual: Parar (ok)', 'tx');
          }
        } catch (err) {
          logConsole(`Erro: ${err.message}`, 'info');
        }
      }

      // ========== Init ==========
      async function checkExistingConnection() {
        console.log('üîç Verificando conex√£o existente...');

        try {
          // Verifica o status real no backend
          const res = await fetch(`${API_BASE}/serial/status`);
          const status = await res.json();

          console.log('ÔøΩ Status do backend:', status);

          if (status.connected && status.port) {
            // Backend est√° conectado
            isConnected = true;
            document.getElementById('btn-connect').classList.add('hidden');
            document.getElementById('btn-disconnect').classList.remove('hidden');
            document.getElementById('serial-status').className = 'mt-4 px-4 py-3 rounded-lg bg-green-50 border border-green-200';
            document.getElementById('serial-status').innerHTML = '<span class="text-green-800 font-medium">‚úÖ Conectado em ' + status.port + '</span>';

            // Preenche o select com a porta conectada
            const select = document.getElementById('serial-port');
            if (![...select.options].some((opt) => opt.value === status.port)) {
              const opt = document.createElement('option');
              opt.value = status.port;
              opt.textContent = status.port;
              opt.selected = true;
              select.appendChild(opt);
            } else {
              select.value = status.port;
            }

            // Atualiza localStorage
            localStorage.setItem('serial_connected', 'true');
            localStorage.setItem('serial_port', status.port);

            logConsole(`Reconectado √† sess√£o: ${status.port}`, 'info');

            // Reconecta ao WebSocket
            initWebSocket();
          } else {
            // Backend n√£o est√° conectado
            console.log('‚ùå Backend n√£o est√° conectado');
            localStorage.setItem('serial_connected', 'false');
            localStorage.removeItem('serial_port');
          }
        } catch (err) {
          console.error('‚ö†Ô∏è Erro ao verificar status:', err);
          localStorage.setItem('serial_connected', 'false');
          localStorage.removeItem('serial_port');
        }
      }

      window.addEventListener('DOMContentLoaded', async () => {
        await refreshPorts();
        await checkExistingConnection();
        logConsole('Interface PID carregada.', 'info');
      });
    </script>
  </body>
</html>

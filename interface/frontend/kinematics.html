<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plataforma de Stewart - Cinem√°tica</title>
    <link rel="icon" type="image/svg+xml" href="./assets/ifsp.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      .pulse-dot {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }
      .panel {
        background: #1f2937;
        padding: 28px;
        border-radius: 12px;
        border: 1px solid #374151;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }
      .section-title {
        color: #f9fafb;
        margin-bottom: 24px;
        font-size: 1.25em;
        font-weight: 600;
        text-align: left;
      }
      .input-group {
        margin-bottom: 20px;
      }
      .input-group h3 {
        color: #d1d5db;
        font-size: 0.875em;
        margin-bottom: 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .input-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
      }
      .input-field {
        display: flex;
        flex-direction: column;
      }
      label {
        color: #9ca3af;
        font-weight: 500;
        margin-bottom: 6px;
        font-size: 0.875em;
      }
      input[type="number"] {
        padding: 10px 12px;
        border: 1px solid #4b5563;
        border-radius: 8px;
        font-size: 0.95em;
        transition: all 0.2s;
        background: #374151;
        color: #f9fafb;
      }
      input[type="number"]:focus {
        outline: none;
        border-color: #2f9e41;
        background: #4b5563;
        box-shadow: 0 0 0 3px rgba(47, 158, 65, 0.1);
      }
      .slider-container {
        margin-top: 8px;
      }
      input[type="range"] {
        width: 100%;
        height: 4px;
        border-radius: 2px;
        background: #4b5563;
        outline: none;
        appearance: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #2f9e41;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      input[type="range"]::-webkit-slider-thumb:hover {
        background: #1a6b2d;
        transform: scale(1.1);
      }
      input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #2f9e41;
        border: none;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      input[type="range"]::-moz-range-thumb:hover {
        background: #1a6b2d;
        transform: scale(1.1);
      }
      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
      }
      button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      }
      .btn-primary {
        background: #2f9e41;
        color: #fff;
        padding: 12px 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .btn-primary:hover {
        background: #1a6b2d;
        box-shadow: 0 4px 12px rgba(47, 158, 65, 0.3);
        transform: translateY(-1px);
      }
      .btn-secondary {
        background: #4b5563;
        color: #f9fafb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
      .btn-secondary:hover {
        background: #6b7280;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        transform: translateY(-1px);
      }
      .status-indicator {
        padding: 16px;
        border-radius: 10px;
        text-align: center;
        font-weight: 600;
        font-size: 0.95em;
        margin-bottom: 24px;
        border: 1px solid;
      }
      .status-valid {
        background: #ecfdf5;
        color: #065f46;
        border-color: #10b981;
      }
      .status-invalid {
        background: #fef2f2;
        color: #991b1b;
        border-color: #ef4444;
      }
      .canvas-container {
        width: 100%;
        height: 420px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: linear-gradient(135deg, #0f172a, #1e293b);
        position: relative;
        overflow: hidden;
        margin-top: 16px;
      }
      #canvas-preview,
      #canvas-live {
        width: 100%;
        height: 100%;
      }
      .controls-3d,
      .legend {
        position: absolute;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(8px);
        color: #f1f5f9;
        padding: 12px;
        border-radius: 8px;
        font-size: 11px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        z-index: 10;
      }
      .controls-3d {
        top: 10px;
        right: 10px;
      }
      .legend {
        bottom: 10px;
        left: 10px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
      }
      .legend-color {
        width: 12px;
        height: 12px;
        margin-right: 8px;
        border-radius: 2px;
      }
      .loading {
        display: none;
        text-align: center;
        color: #2f9e41;
        font-style: italic;
        margin-top: 6px;
        font-weight: 600;
      }
      .error-message {
        display: none;
        background: #fef2f2;
        color: #991b1b;
        padding: 12px;
        border-radius: 8px;
        margin-top: 12px;
        border: 1px solid #ef4444;
        font-size: 0.875em;
      }
      .btn-reset-cam {
        background: rgba(47, 158, 65, 0.9);
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 10px;
        transition: all 0.2s;
        font-weight: 500;
      }
      .btn-reset-cam:hover {
        background: #2f9e41;
        box-shadow: 0 2px 8px rgba(47, 158, 65, 0.3);
      }
      .piston-measures {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 12px;
        padding: 12px;
        background: #374151;
        border-radius: 8px;
        border: 1px solid #4b5563;
      }
      .piston-card {
        background: #1f2937;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #4b5563;
        text-align: center;
        font-size: 0.75em;
      }
      .piston-card .piston-id {
        font-weight: 600;
        color: #d1d5db;
        margin-bottom: 4px;
      }
      .piston-card .piston-length {
        font-size: 1.1em;
        font-weight: 700;
        color: #10b981;
      }
      /* Motion Routines Styles */
      .motion-preset-card {
        background: #1f2937;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #374151;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .motion-preset-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border-color: #4b5563;
      }
      .motion-preset-card.active {
        border-color: #10b981;
        background: linear-gradient(135deg, #1f2937 0%, #065f46 100%);
      }
      .motion-param-input {
        background: #374151;
        border: 1px solid #4b5563;
        border-radius: 6px;
        padding: 6px 10px;
        color: #f3f4f6;
        width: 100%;
        font-size: 0.875em;
      }
      .motion-param-input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
      }
      .motion-status-running {
        background: #10b981;
        animation: pulse-motion 2s infinite;
      }
      .motion-status-stopped {
        background: #6b7280;
      }
      @keyframes pulse-motion {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      @media (max-width: 1024px) {
        .main-content {
          grid-template-columns: 1fr;
        }
        .input-row {
          grid-template-columns: 1fr;
        }
        .piston-measures {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <!-- Header -->
      <div
        class="bg-gray-800 rounded-2xl shadow-sm p-8 mb-6 border border-gray-700"
      >
        <div class="text-center">
          <h1 class="text-4xl font-bold text-white mb-2">
            Plataforma de Stewart - Cinem√°tica
          </h1>
          <div class="flex justify-center items-center gap-2">
            <img src="./assets/ifsp.svg" alt="logo IFSP" class="w-6" />
            <p class="text-gray-300">Instituto Federal de S√£o Paulo</p>
          </div>
        </div>
      </div>

      <!-- Navega√ß√£o -->
      <div
        class="bg-gray-800 rounded-2xl shadow-sm p-4 mb-6 border border-gray-700"
      >
        <div class="flex flex-wrap gap-2 justify-center">
          <a
            href="index.html"
            class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg transition-colors font-medium"
            >üè† In√≠cio</a
          >
          <a
            href="kinematics.html"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold"
            >üìê Cinem√°tica</a
          >
          <a
            href="actuators.html"
            class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg transition-colors font-medium"
            >üéÆ Controle</a
          >
          <a
            href="settings.html"
            class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg transition-colors font-medium"
            >‚öôÔ∏è Configura√ß√µes</a
          >
        </div>
      </div>

      <!-- Status da Conex√£o -->
      <div
        id="connection-status"
        class="bg-gray-800 rounded-2xl shadow-sm p-4 mb-6 border border-gray-700"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div
              id="status-indicator"
              class="w-3 h-3 rounded-full bg-red-500"
            ></div>
            <span id="status-text" class="font-medium text-gray-300"
              >Desconectado</span
            >
          </div>
          <span id="status-port" class="text-sm text-gray-400">--</span>
        </div>
      </div>

      <!-- Conex√£o Serial -->
      <div
        class="bg-gray-800 rounded-2xl shadow-sm p-6 mb-6 border border-gray-700"
      >
        <h2 class="text-xl font-semibold text-white mb-4">üîå Conex√£o Serial</h2>
        <div class="flex flex-wrap gap-4 items-end">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-300 mb-2"
              >Porta Serial</label
            >
            <select
              id="serial-port-select"
              class="w-full text-white px-4 py-2 border bg-gray-700 border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
            >
              <option value="">Selecione...</option>
            </select>
          </div>
          <button
            id="btn-refresh-ports"
            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors font-medium"
          >
            ‚Üª Atualizar
          </button>
          <button
            id="btn-open-serial"
            class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-semibold"
          >
            Conectar
          </button>
          <button
            id="btn-close-serial"
            class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-semibold hidden"
          >
            Desconectar
          </button>
        </div>
      </div>

      <!-- === Controles de Posi√ß√£o === -->
      <div
        class="bg-gray-800 rounded-2xl shadow-sm p-6 mb-6 border border-gray-700"
      >
        <h2 class="text-xl font-semibold text-white mb-4">
          üéÆ Controles de Posi√ß√£o
        </h2>

        <div class="input-group">
          <h3>Transla√ß√£o (mm)</h3>
          <div class="input-row">
            <div class="input-field">
              <label for="x-pos">X</label>
              <input
                type="number"
                id="x-pos"
                value="0"
                min="-50"
                max="50"
                step="1"
              />
              <div class="slider-container">
                <input
                  type="range"
                  id="x-slider"
                  min="-50"
                  max="50"
                  value="0"
                  step="1"
                />
              </div>
            </div>
            <div class="input-field">
              <label for="y-pos">Y</label>
              <input
                type="number"
                id="y-pos"
                value="0"
                min="-50"
                max="50"
                step="1"
              />
              <div class="slider-container">
                <input
                  type="range"
                  id="y-slider"
                  min="-50"
                  max="50"
                  value="0"
                  step="1"
                />
              </div>
            </div>
            <div class="input-field">
              <label for="z-pos">Z</label>
              <input
                type="number"
                id="z-pos"
                value="500"
                min="433"
                max="631"
                step="1"
              />
              <div class="slider-container">
                <input
                  type="range"
                  id="z-slider"
                  min="433"
                  max="631"
                  value="500"
                  step="1"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="input-group">
          <h3>Rota√ß√£o (graus)</h3>
          <div class="input-row">
            <div class="input-field">
              <label for="roll">Roll</label>
              <input
                type="number"
                id="roll"
                value="0"
                min="-15"
                max="15"
                step="0.1"
              />
              <div class="slider-container">
                <input
                  type="range"
                  id="roll-slider"
                  min="-15"
                  max="15"
                  value="0"
                  step="0.1"
                />
              </div>
            </div>
            <div class="input-field">
              <label for="pitch">Pitch</label>
              <input
                type="number"
                id="pitch"
                value="0"
                min="-15"
                max="15"
                step="0.1"
              />
              <div class="slider-container">
                <input
                  type="range"
                  id="pitch-slider"
                  min="-15"
                  max="15"
                  value="0"
                  step="0.1"
                />
              </div>
            </div>
            <div class="input-field">
              <label for="yaw">Yaw</label>
              <input
                type="number"
                id="yaw"
                value="0"
                min="-15"
                max="15"
                step="0.1"
              />
              <div class="slider-container">
                <input
                  type="range"
                  id="yaw-slider"
                  min="-15"
                  max="15"
                  value="0"
                  step="0.1"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-primary" id="btn-calc">Calcular Posi√ß√£o</button>
          <button class="btn-secondary" id="btn-reset">Resetar</button>
        </div>

        <!-- Bot√£o para aplicar na bancada (inicialmente oculto) -->
        <button
          class="btn-primary"
          id="btn-apply"
          style="display: none; margin-top: 12px; width: 100%"
        >
          üöÄ Aplicar na Bancada
        </button>

        <div class="loading" id="loading">Calculando‚Ä¶</div>
        <div class="error-message" id="error-message"></div>
        <div class="error-message" id="apply-error"></div>
      </div>

      <!-- === Preview e Live lado a lado === -->
      <div class="main-content">
        <!-- Preview (Simulada) -->
        <div
          class="bg-gray-800 rounded-2xl shadow-sm p-6 border border-gray-700"
        >
          <h2 class="text-xl font-semibold text-white mb-4">
            Preview (Simulada)
          </h2>

          <div class="canvas-container">
            <div id="canvas-preview"></div>
            <div class="controls-3d">
              <div>üñ±Ô∏è Rotacionar | üñ≤Ô∏è Zoom | Ctrl+Mouse: Pan</div>
              <div style="margin-top: 8px">
                <button id="btn-reset-cam-prev" class="btn-reset-cam">
                  Reset View
                </button>
              </div>
            </div>
            <div class="legend">
              <div class="legend-item">
                <div class="legend-color" style="background: #cd191e"></div>
                <span>Base</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #2f9e41"></div>
                <span>Plataforma</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #50c878"></div>
                <span>Atuador OK</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #ff4444"></div>
                <span>Atuador Inv√°lido</span>
              </div>
            </div>
          </div>

          <!-- Medidas dos pist√µes (Preview) -->
          <div class="piston-measures" id="piston-measures-preview">
            <div class="piston-card">
              <div class="piston-id">Pist√£o 1</div>
              <div class="piston-length" id="preview-piston-1">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 2</div>
              <div class="piston-length" id="preview-piston-2">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 3</div>
              <div class="piston-length" id="preview-piston-3">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 4</div>
              <div class="piston-length" id="preview-piston-4">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 5</div>
              <div class="piston-length" id="preview-piston-5">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 6</div>
              <div class="piston-length" id="preview-piston-6">--</div>
            </div>
          </div>
        </div>

        <!-- Live (WebSocket) -->
        <div
          class="bg-gray-800 rounded-2xl shadow-sm p-6 border border-gray-700"
        >
          <h2 class="text-xl font-semibold text-gray-300 mb-4">
            Live (WebSocket)
          </h2>

          <div class="canvas-container">
            <div id="canvas-live"></div>
            <div class="controls-3d">
              <div>üñ±Ô∏è Rotacionar | üñ≤Ô∏è Zoom | Ctrl+Mouse: Pan</div>
              <div style="margin-top: 8px">
                <button id="btn-reset-cam-live" class="btn-reset-cam">
                  Reset View
                </button>
              </div>
            </div>
            <div class="legend">
              <div class="legend-item">
                <div class="legend-color" style="background: #cd191e"></div>
                <span>Base</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #2f9e41"></div>
                <span>Plataforma</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #50c878"></div>
                <span>Atuador OK</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: #ff4444"></div>
                <span>Atuador Inv√°lido</span>
              </div>
            </div>
          </div>

          <!-- Medidas dos pist√µes (Live) -->
          <div class="piston-measures" id="piston-measures-live">
            <div class="piston-card">
              <div class="piston-id">Pist√£o 1</div>
              <div class="piston-length" id="live-piston-1">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 2</div>
              <div class="piston-length" id="live-piston-2">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 3</div>
              <div class="piston-length" id="live-piston-3">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 4</div>
              <div class="piston-length" id="live-piston-4">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 5</div>
              <div class="piston-length" id="live-piston-5">--</div>
            </div>
            <div class="piston-card">
              <div class="piston-id">Pist√£o 6</div>
              <div class="piston-length" id="live-piston-6">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- === Motion Routines === -->
      <div
        class="bg-gray-800 rounded-2xl shadow-sm p-6 mb-6 border border-gray-700"
      >
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-white">
            üé¨ Rotinas de Movimento
          </h2>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <span
                class="w-3 h-3 rounded-full motion-status-stopped"
                id="motion-status-dot"
              ></span>
              <span id="motion-status-text" class="text-sm text-gray-400"
                >Parado</span
              >
            </div>
            <span id="motion-elapsed" class="text-lg font-mono text-green-400"
              >00:00</span
            >
            <button
              id="btn-motion-stop"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-semibold text-sm disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              ‚èπÔ∏è Parar
            </button>
            <button
              id="btn-toggle-motion-chart"
              onclick="toggleMotionChart()"
              class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-semibold text-sm"
            >
              üìä Mostrar Gr√°fico
            </button>
          </div>
        </div>

        <!-- Se√ß√£o do Gr√°fico de Movimento (inicialmente oculta) -->
        <div id="motion-chart-section" class="bg-gray-800 rounded-2xl shadow-sm p-4 sm:p-6 mb-6 border border-gray-700 hidden">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
            <h2 class="text-lg sm:text-xl font-semibold text-white">
              üìà Trajet√≥ria do Movimento em Tempo Real
            </h2>
            <div class="flex flex-wrap gap-2">
              <button
                id="btn-start-motion-chart"
                onclick="startMotionChart()"
                class="px-3 sm:px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-semibold text-sm"
              >
                ‚ñ∂Ô∏è Iniciar
              </button>
              <button
                id="btn-stop-motion-chart"
                onclick="stopMotionChart()"
                class="px-3 sm:px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-semibold text-sm hidden"
              >
                ‚è∏ Parar
              </button>
              <button
                id="btn-reset-zoom-chart"
                onclick="resetMotionChartZoom()"
                class="px-3 sm:px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-semibold text-sm"
              >
                üîç Reset Zoom
              </button>
              <button
                id="btn-clear-motion-chart"
                onclick="clearMotionChart()"
                class="px-3 sm:px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors font-semibold text-sm"
              >
                üóëÔ∏è Limpar
              </button>
              <button
                id="btn-export-motion-csv"
                onclick="exportMotionToCSV()"
                class="px-3 sm:px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-semibold text-sm"
              >
                üíæ Exportar CSV
              </button>
            </div>
          </div>
          <div class="bg-gray-900 rounded-lg p-2 sm:p-4" style="height: 400px">
            <canvas id="motion-chart"></canvas>
          </div>
          <div class="mt-4">
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm font-semibold text-gray-300">Pist√µes Vis√≠veis:</span>
              <div class="flex gap-2 flex-wrap">
                <button
                  onclick="toggleAllMotionPistons(true)"
                  class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded"
                >
                  Todos
                </button>
                <button
                  onclick="toggleMotionPistonsByType('cmd')"
                  class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded"
                >
                  S√≥ CMD
                </button>
                <button
                  onclick="toggleMotionPistonsByType('real')"
                  class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded"
                >
                  S√≥ Real
                </button>
                <button
                  onclick="toggleAllMotionPistons(false)"
                  class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded"
                >
                  Nenhum
                </button>
              </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2 text-xs">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="motion-piston-1-visible" checked onchange="toggleMotionPistonVisibility(1)" class="w-4 h-4" />
                <span class="text-red-500">‚óè P1 CMD</span>
                <span class="text-red-400">‚îÅ P1 Real</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="motion-piston-2-visible" checked onchange="toggleMotionPistonVisibility(2)" class="w-4 h-4" />
                <span class="text-orange-500">‚óè P2 CMD</span>
                <span class="text-orange-400">‚îÅ P2 Real</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="motion-piston-3-visible" checked onchange="toggleMotionPistonVisibility(3)" class="w-4 h-4" />
                <span class="text-yellow-500">‚óè P3 CMD</span>
                <span class="text-yellow-400">‚îÅ P3 Real</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="motion-piston-4-visible" checked onchange="toggleMotionPistonVisibility(4)" class="w-4 h-4" />
                <span class="text-green-500">‚óè P4 CMD</span>
                <span class="text-green-400">‚îÅ P4 Real</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="motion-piston-5-visible" checked onchange="toggleMotionPistonVisibility(5)" class="w-4 h-4" />
                <span class="text-blue-500">‚óè P5 CMD</span>
                <span class="text-blue-400">‚îÅ P5 Real</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="motion-piston-6-visible" checked onchange="toggleMotionPistonVisibility(6)" class="w-4 h-4" />
                <span class="text-purple-500">‚óè P6 CMD</span>
                <span class="text-purple-400">‚îÅ P6 Real</span>
              </label>
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-400 text-center">
            üí° Dica: Use a roda do mouse para zoom, arraste para pan, ou clique duplo para resetar
          </div>
          <div id="motion-chart-status" class="mt-2 text-sm text-gray-400 text-center">
            Pronto para iniciar grava√ß√£o
          </div>
        </div>

        <!-- Grid de Presets -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Preset: Seno Z -->
          <div class="motion-preset-card" data-preset="sine_z">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-base font-bold text-blue-400">üîµ Seno Z</h3>
              <span class="text-2xl">üìä</span>
            </div>
            <p class="text-gray-400 text-xs mb-3">
              Movimento vertical senoidal
            </p>
            <div class="space-y-2 mb-3">
              <div>
                <label class="text-xs text-gray-400">Amplitude (mm)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="amp"
                  value="10"
                  min="10"
                  max="40"
                  step="0.5"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Frequ√™ncia (Hz)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="hz"
                  value="0.5"
                  min="0.1"
                  max="1.5"
                  step="0.05"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Dura√ß√£o (s)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="duration_s"
                  value="45"
                  min="5"
                  max="300"
                  step="5"
                />
              </div>
            </div>
            <button
              class="btn-start-motion w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold text-sm transition"
            >
              ‚ñ∂Ô∏è Iniciar
            </button>
          </div>

          <!-- Preset: C√≠rculo XY -->
          <div class="motion-preset-card" data-preset="circle_xy">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-base font-bold text-purple-400">üü£ C√≠rculo XY</h3>
              <span class="text-2xl">‚≠ï</span>
            </div>
            <p class="text-gray-400 text-xs mb-3">
              Movimento circular horizontal
            </p>
            <div class="space-y-2 mb-3">
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-gray-400">Raio X (mm)</label>
                  <input
                    type="number"
                    class="motion-param-input"
                    data-param="ax"
                    value="20"
                    min="10"
                    max="40"
                    step="1"
                  />
                </div>
                <div>
                  <label class="text-xs text-gray-400">Raio Y (mm)</label>
                  <input
                    type="number"
                    class="motion-param-input"
                    data-param="ay"
                    value="20"
                    min="10"
                    max="40"
                    step="1"
                  />
                </div>
              </div>
              <div>
                <label class="text-xs text-gray-400">Frequ√™ncia (Hz)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="hz"
                  value="0.75"
                  min="0.2"
                  max="1.5"
                  step="0.05"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Dura√ß√£o (s)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="duration_s"
                  value="60"
                  min="5"
                  max="300"
                  step="5"
                />
              </div>
            </div>
            <button
              class="btn-start-motion w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-semibold text-sm transition"
            >
              ‚ñ∂Ô∏è Iniciar
            </button>
          </div>

          <!-- Preset: Heave-Pitch -->
          <div class="motion-preset-card" data-preset="heave_pitch">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-base font-bold text-orange-400">
                üü† Heave-Pitch
              </h3>
              <span class="text-2xl">üåä</span>
            </div>
            <p class="text-gray-400 text-xs mb-3">Simula√ß√£o de onda mar√≠tima</p>
            <div class="space-y-2 mb-3">
              <div>
                <label class="text-xs text-gray-400">Amplitude Z (mm)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="amp"
                  value="20"
                  min="10"
                  max="25"
                  step="0.5"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Amplitude Pitch (¬∞)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="ay"
                  value="3.5"
                  min="1.5"
                  max="3.5"
                  step="0.5"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Frequ√™ncia (Hz)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="hz"
                  value="0.8"
                  min="0.3"
                  max="0.8"
                  step="0.05"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Dura√ß√£o (s)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="duration_s"
                  value="40"
                  min="5"
                  max="300"
                  step="5"
                />
              </div>
            </div>
            <button
              class="btn-start-motion w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-lg font-semibold text-sm transition"
            >
              ‚ñ∂Ô∏è Iniciar
            </button>
          </div>

          <!-- Preset: Seno Pitch -->
          <div class="motion-preset-card" data-preset="sine_pitch">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-base font-bold text-teal-400">üî∑ Seno Pitch</h3>
              <span class="text-2xl">‚ÜïÔ∏è</span>
            </div>
            <p class="text-gray-400 text-xs mb-3">Balan√ßo frontal angular</p>
            <div class="space-y-2 mb-3">
              <div>
                <label class="text-xs text-gray-400">Amplitude (¬∞)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="amp"
                  value="5"
                  min="0.5"
                  max="5"
                  step="0.5"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Frequ√™ncia (Hz)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="hz"
                  value="0.8"
                  min="0.1"
                  max="0.8"
                  step="0.05"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Dura√ß√£o (s)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="duration_s"
                  value="30"
                  min="5"
                  max="300"
                  step="5"
                />
              </div>
            </div>
            <button
              class="btn-start-motion w-full bg-teal-600 hover:bg-teal-700 text-white py-2 rounded-lg font-semibold text-sm transition"
            >
              ‚ñ∂Ô∏è Iniciar
            </button>
          </div>

          <!-- Preset: Seno Roll -->
          <div class="motion-preset-card" data-preset="sine_roll">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-base font-bold text-indigo-400">üî∂ Seno Roll</h3>
              <span class="text-2xl">‚ÜîÔ∏è</span>
            </div>
            <p class="text-gray-400 text-xs mb-3">Balan√ßo lateral angular</p>
            <div class="space-y-2 mb-3">
              <div>
                <label class="text-xs text-gray-400">Amplitude (¬∞)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="amp"
                  value="5"
                  min="0.2"
                  max="5"
                  step="0.5"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Frequ√™ncia (Hz)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="hz"
                  value="0.8"
                  min="0.2"
                  max="0.8"
                  step="0.05"
                />
              </div>
              <div>
                <label class="text-xs text-gray-400">Dura√ß√£o (s)</label>
                <input
                  type="number"
                  class="motion-param-input"
                  data-param="duration_s"
                  value="30"
                  min="5"
                  max="300"
                  step="5"
                />
              </div>
            </div>
            <button
              class="btn-start-motion w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-semibold text-sm transition"
            >
              ‚ñ∂Ô∏è Iniciar
            </button>
          </div>

          <!-- Preset: Helix (Parafuso) -->
          <div class="motion-preset-card" data-preset="helix">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-base font-bold text-pink-400">üî© Helix</h3>
              <span class="text-2xl">üåÄ</span>
            </div>
            <p class="text-gray-400 text-xs mb-3">Parafuso: sobe girando, desce voltando</p>
            <div class="space-y-2 mb-3">
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-gray-400">Raio X</label>
                  <input
                    type="number"
                    class="motion-param-input"
                    data-param="ax"
                    value="10"
                    min="10"
                    max="40"
                    step="1"
                  />
                </div>
                <div>
                  <label class="text-xs text-gray-400">Raio Y</label>
                  <input
                    type="number"
                    class="motion-param-input"
                    data-param="ay"
                    value="10"
                    min="10"
                    max="40"
                    step="1"
                  />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-gray-400">Amp Z (mm)</label>
                  <input
                    type="number"
                    class="motion-param-input"
                    data-param="z_amp_mm"
                    value="10"
                    min="10"
                    max="40"
                    step="0.5"
                  />
                </div>
                <div>
                  <label class="text-xs text-gray-400">Ciclos Z</label>
                  <input
                    type="number"
                    class="motion-param-input"
                    data-param="z_cycles"
                    value="1"
                    min="0.2"
                    max="1"
                    step="0.5"
                  />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-gray-400">Freq (Hz)</label>
                  <input
                    type="number"
                    class="motion-param-input"
                    data-param="hz"
                    value="0.2"
                    min="0.1"
                    max="1.5"
                    step="0.05"
                  />
                </div>
                <div>
                  <label class="text-xs text-gray-400">Dura√ß√£o (s)</label>
                  <input
                    type="number"
                    class="motion-param-input"
                    data-param="duration_s"
                    value="60"
                    min="5"
                    max="300"
                    step="5"
                  />
                </div>
              </div>
            </div>
            <button
              class="btn-start-motion w-full bg-pink-600 hover:bg-pink-700 text-white py-2 rounded-lg font-semibold text-sm transition"
            >
              ‚ñ∂Ô∏è Iniciar
            </button>
          </div>


        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:8001";
      const WS_URL = "ws://localhost:8001/ws/telemetry";
      let currentPlatformData = null;
      window.__threeScenes = {};
      
      // ========== Vari√°veis do Gr√°fico de Movimento ==========
      let motionChart = null;
      let motionChartVisible = false;
      let motionDB = null;
      const MOTION_DB_NAME = "MotionTrajectoryDB";
      const MOTION_DB_VERSION = 1;
      const MOTION_STORE_NAME = "motion_data";
      
      // Configura√ß√£o da janela de visualiza√ß√£o (mais ampla que actuators.html)
      const CHART_WINDOW_SECONDS = 60; // Janela de 60 segundos (2x actuators.html)
      let maxDataPoints = 1000; // M√°ximo de pontos no gr√°fico
      let motionStartTimestamp = null; // Timestamp do primeiro dado
      let chartRecording = false; // Controla se est√° gravando ou n√£o
      let motionChartData = []; // Dados em mem√≥ria

      function setupInputSync() {
        const inputs = ["x-pos", "y-pos", "z-pos", "roll", "pitch", "yaw"];
        const sliders = [
          "x-slider",
          "y-slider",
          "z-slider",
          "roll-slider",
          "pitch-slider",
          "yaw-slider",
        ];
        inputs.forEach((id, i) => {
          const input = document.getElementById(id);
          const slider = document.getElementById(sliders[i]);
          if (!input || !slider) return;
          input.addEventListener("input", () => {
            slider.value = input.value;
          });
          slider.addEventListener("input", () => {
            input.value = slider.value;
          });
        });
      }

      function getPoseFromUI() {
        return {
          x: parseFloat(document.getElementById("x-pos").value),
          y: parseFloat(document.getElementById("y-pos").value),
          z: parseFloat(document.getElementById("z-pos").value),
          roll: parseFloat(document.getElementById("roll").value),
          pitch: parseFloat(document.getElementById("pitch").value),
          yaw: parseFloat(document.getElementById("yaw").value),
        };
      }

      // Atualiza medidas dos pist√µes do Preview (calculado manualmente)
      function updatePreviewMeasures(actuators) {
        (actuators || []).forEach((a, index) => {
          const el = document.getElementById(`preview-piston-${index + 1}`);
          const card = el?.parentElement;
          if (el && card) {
            el.textContent = Number(a.length).toFixed(1) + " mm";
            // Aplica estilo v√°lido ou inv√°lido
            if (a.valid) {
              card.style.borderColor = "#10b981";
              card.style.backgroundColor = "#1f2937";
              el.style.color = "#10b981";
            } else {
              card.style.borderColor = "#ef4444";
              card.style.backgroundColor = "#1f2937";
              el.style.color = "#ef4444";
            }
          }
        });
      }

      // Atualiza medidas dos pist√µes do Live (WebSocket real-time)
      function updateLiveMeasures(actuators) {
        // Capturar os valores reais para usar no gr√°fico
        if (actuators && actuators.length >= 6) {
          window.lastActuatorsReal = actuators.map(a => Number(a.length) || 0);
        }
        
        (actuators || []).forEach((a, index) => {
          const el = document.getElementById(`live-piston-${index + 1}`);
          const card = el?.parentElement;
          if (el && card) {
            el.textContent = Number(a.length).toFixed(1) + " mm";
            // Aplica estilo v√°lido ou inv√°lido
            if (a.valid) {
              card.style.borderColor = "#10b981";
              card.style.backgroundColor = "#1f2937";
              el.style.color = "#10b981";
            } else {
              card.style.borderColor = "#ef4444";
              card.style.backgroundColor = "#1f2937";
              el.style.color = "#ef4444";
            }
          }
        });
      }

      const COLORS = {
        base: 0xcd191e,
        platform: 0x2f9e41,
        actuatorValid: 0x50c878,
        actuatorInvalid: 0xff4444,
        background: 0x0f172a,
        grid: 0x475569,
      };

      function init3D(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = "";

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(COLORS.background);

        const width = container.offsetWidth || 600;
        const height = container.offsetHeight || 420;
        const camera = new THREE.PerspectiveCamera(
          75,
          width / height,
          0.1,
          2000
        );
        camera.position.set(500, 500, 500);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        let controls = null;
        if (typeof THREE.OrbitControls !== "undefined") {
          controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true;
          controls.dampingFactor = 0.05;
          controls.target.set(0, 200, 0);
        }

        scene.add(new THREE.AmbientLight(0x404040, 0.6));
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(200, 300, 200);
        dir.castShadow = true;
        scene.add(dir);

        const grid = new THREE.GridHelper(600, 30, COLORS.grid, COLORS.grid);
        grid.position.y = -50;
        scene.add(grid);

        const baseGroup = new THREE.Group();
        const platformGroup = new THREE.Group();
        const actuatorGroup = new THREE.Group();
        scene.add(baseGroup, platformGroup, actuatorGroup);

        function onResize() {
          const w = container.offsetWidth || 600;
          const h = container.offsetHeight || 420;
          camera.aspect = w / h;
          camera.updateProjectionMatrix();
          renderer.setSize(w, h);
        }
        window.addEventListener("resize", onResize);

        function animate() {
          requestAnimationFrame(animate);
          if (controls) controls.update();
          renderer.render(scene, camera);
        }
        animate();

        window.__threeScenes[containerId] = {
          scene,
          camera,
          renderer,
          controls,
          baseGroup,
          platformGroup,
          actuatorGroup,
        };
      }

      function createBasePoint(position) {
        const g = new THREE.Group();
        const sph = new THREE.Mesh(
          new THREE.SphereGeometry(8, 16, 16),
          new THREE.MeshPhongMaterial({ color: COLORS.base })
        );
        sph.castShadow = true;
        g.add(sph);
        g.position.set(position[0], position[2] || 0, position[1]);
        return g;
      }

      function createPlatformPoint(position) {
        const g = new THREE.Group();
        const sph = new THREE.Mesh(
          new THREE.SphereGeometry(6, 16, 16),
          new THREE.MeshPhongMaterial({ color: COLORS.platform })
        );
        sph.castShadow = true;
        g.add(sph);
        g.position.set(position[0], position[2], position[1]);
        return g;
      }

      function createActuator(startPos, endPos, actuator) {
        const g = new THREE.Group();
        const start = new THREE.Vector3(
          startPos[0],
          startPos[2] || 0,
          startPos[1]
        );
        const end = new THREE.Vector3(endPos[0], endPos[2], endPos[1]);
        const length = start.distanceTo(end);
        const cyl = new THREE.Mesh(
          new THREE.CylinderGeometry(3, 3, length, 8),
          new THREE.MeshPhongMaterial({
            color: actuator.valid
              ? COLORS.actuatorValid
              : COLORS.actuatorInvalid,
          })
        );
        const mid = start.clone().add(end).multiplyScalar(0.5);
        cyl.position.copy(mid);
        cyl.lookAt(end);
        cyl.rotateX(Math.PI / 2);
        cyl.castShadow = true;
        g.add(cyl);
        return g;
      }

      function draw3DPlatform(containerId, data) {
        const ctx = window.__threeScenes[containerId];
        if (!ctx) return;
        const { scene, controls, baseGroup, platformGroup, actuatorGroup } =
          ctx;
        /*
        ////console.log(`üé® draw3DPlatform(${containerId}):`, {
          base_points_count: data.base_points?.length,
          platform_points_count: data.platform_points?.length,
          actuators_count: data.actuators?.length,
          base_points_sample: data.base_points?.[0],
          platform_points_sample: data.platform_points?.[0],
        });
*/
        baseGroup.clear();
        platformGroup.clear();
        actuatorGroup.clear();

        const bs = data.base_points;
        const baseShape = new THREE.Shape();
        baseShape.moveTo(bs[0][0], bs[0][1]);
        for (let i = 1; i < bs.length; i++)
          baseShape.lineTo(bs[i][0], bs[i][1]);
        baseShape.closePath();
        const baseGeo = new THREE.ShapeGeometry(baseShape);
        const baseMat = new THREE.MeshPhongMaterial({
          color: COLORS.base,
          transparent: true,
          opacity: 0.4,
          side: THREE.DoubleSide,
        });
        const baseSurf = new THREE.Mesh(baseGeo, baseMat);
        baseSurf.rotation.x = -Math.PI / 2;
        baseSurf.position.y = -5;
        baseSurf.receiveShadow = true;
        baseGroup.add(baseSurf);

        const baseEdges = new THREE.EdgesGeometry(baseGeo);
        const baseWire = new THREE.LineSegments(
          baseEdges,
          new THREE.LineBasicMaterial({ color: COLORS.base })
        );
        baseWire.rotation.x = -Math.PI / 2;
        baseWire.position.y = -4;
        baseGroup.add(baseWire);

        bs.forEach((p) => baseGroup.add(createBasePoint(p)));

        const verts = [],
          idx = [];
        const ps = data.platform_points;
        ps.forEach((p) => verts.push(p[0], p[2], p[1]));
        let cx = 0,
          cy = 0,
          cz = 0;
        ps.forEach((p) => {
          cx += p[0];
          cy += p[2];
          cz += p[1];
        });
        cx /= ps.length;
        cy /= ps.length;
        cz /= ps.length;
        verts.push(cx, cy, cz);
        const cIndex = ps.length;
        for (let i = 0; i < ps.length; i++) {
          const n = (i + 1) % ps.length;
          idx.push(i, n, cIndex);
        }

        const platGeo = new THREE.BufferGeometry();
        platGeo.setIndex(idx);
        platGeo.setAttribute(
          "position",
          new THREE.Float32BufferAttribute(verts, 3)
        );
        platGeo.computeVertexNormals();
        const platMat = new THREE.MeshPhongMaterial({
          color: COLORS.platform,
          transparent: true,
          opacity: 0.7,
          side: THREE.DoubleSide,
        });
        const platSurf = new THREE.Mesh(platGeo, platMat);
        platSurf.castShadow = true;
        platSurf.receiveShadow = true;
        platformGroup.add(platSurf);

        const edgeVerts = [];
        for (let i = 0; i < ps.length; i++) {
          const p = ps[i];
          edgeVerts.push(p[0], p[2], p[1]);
        }
        const p0 = ps[0];
        edgeVerts.push(p0[0], p0[2], p0[1]);
        const edgeGeo = new THREE.BufferGeometry();
        edgeGeo.setAttribute(
          "position",
          new THREE.Float32BufferAttribute(edgeVerts, 3)
        );
        const edgeLine = new THREE.Line(
          edgeGeo,
          new THREE.LineBasicMaterial({ color: 0x1a6b2d })
        );
        platformGroup.add(edgeLine);

        ps.forEach((p) => platformGroup.add(createPlatformPoint(p)));

        // üîß Conecta diretamente: base[i] -> platform[i]
        // O backend j√° retorna platform_points_live na ordem correta dos pist√µes
        ////console.log('üìä Conectando atuadores (base[i] -> platform[i]):');
        (data.actuators || []).forEach((a, i) => {
          ////console.log(`   Pist√£o ${i + 1}: base[${i}]=(${bs[i][0].toFixed(1)}, ${bs[i][1].toFixed(1)}) -> platform[${i}]=(${ps[i][0].toFixed(1)}, ${ps[i][1].toFixed(1)}, ${ps[i][2].toFixed(1)})`);
          actuatorGroup.add(createActuator(bs[i], ps[i], a));
        });

        if (controls) {
          const h = ps[0][2] || 432;
          controls.target.set(0, h / 2, 0);
        }
      }

      // Fun√ß√£o auxiliar para encontrar a melhor correspond√™ncia entre pontos da base e plataforma
      function findBestConnections(basePoints, platformPoints) {
        // Para cada ponto da base, encontra o ponto da plataforma mais pr√≥ximo
        const connections = [];
        const usedPlatform = new Set();

        for (let i = 0; i < basePoints.length; i++) {
          let minDist = Infinity;
          let bestIdx = -1;

          for (let j = 0; j < platformPoints.length; j++) {
            if (usedPlatform.has(j)) continue; // J√° foi usado

            // Dist√¢ncia 3D entre base[i] e platform[j]
            const dx = basePoints[i][0] - platformPoints[j][0];
            const dy = basePoints[i][1] - platformPoints[j][1];
            const dz = (basePoints[i][2] || 0) - platformPoints[j][2];
            const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

            if (dist < minDist) {
              minDist = dist;
              bestIdx = j;
            }
          }

          connections.push(bestIdx);
          usedPlatform.add(bestIdx);
        }

        ////console.log('üîó Conex√µes base->plataforma:', connections);
        return connections;
      }

      function resetCamera(containerId) {
        const ctx = window.__threeScenes[containerId];
        if (!ctx) return;
        const { camera, controls } = ctx;
        const h =
          (currentPlatformData &&
            currentPlatformData.platform_points?.[0]?.[2]) ||
          432;
        camera.position.set(500, h + 200, 500);
        if (controls) {
          controls.target.set(0, h / 2, 0);
          controls.update();
        }
      }

      async function calculatePosition() {
        const loading = document.getElementById("loading");
        const errBox = document.getElementById("error-message");
        try {
          loading.style.display = "block";
          errBox.style.display = "none";
          const pose = getPoseFromUI();
          const resp = await fetch(`${API_BASE}/calculate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(pose),
          });
          if (!resp.ok)
            throw new Error(`Erro ${resp.status}: ${resp.statusText}`);
          const data = await resp.json();
          currentPlatformData = data;

          updatePreviewMeasures(data.actuators);
          draw3DPlatform("canvas-preview", data);

          // Mostra/oculta bot√£o "Aplicar na Bancada" baseado na validade
          const applyBtn = document.getElementById("btn-apply");
          const applyErr = document.getElementById("apply-error");
          applyErr.style.display = "none";
          if (data.valid) {
            applyBtn.style.display = "block";
          } else {
            applyBtn.style.display = "none";
          }
        } catch (e) {
          console.error(e);
          errBox.textContent = `Erro: ${e.message}`;
          errBox.style.display = "block";
        } finally {
          loading.style.display = "none";
        }
      }

      function resetPosition() {
        document.getElementById("x-pos").value = 0;
        document.getElementById("y-pos").value = 0;
        document.getElementById("z-pos").value = 500;
        document.getElementById("roll").value = 0;
        document.getElementById("pitch").value = 0;
        document.getElementById("yaw").value = 0;
        document.getElementById("x-slider").value = 0;
        document.getElementById("y-slider").value = 0;
        document.getElementById("z-slider").value = 500;
        document.getElementById("roll-slider").value = 0;
        document.getElementById("pitch-slider").value = 0;
        document.getElementById("yaw-slider").value = 0;
        calculatePosition();
      }

      async function applyToBench() {
        const applyBtn = document.getElementById("btn-apply");
        const applyErr = document.getElementById("apply-error");
        const originalText = applyBtn.textContent;

        try {
          applyBtn.disabled = true;
          applyBtn.textContent = "‚è≥ Aplicando...";
          applyErr.style.display = "none";

          if (!currentPlatformData || !currentPlatformData.valid) {
            throw new Error("Calcule uma posi√ß√£o v√°lida primeiro");
          }

          const pose = currentPlatformData.pose;
          const resp = await fetch(`${API_BASE}/apply_pose`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(pose),
          });

          if (!resp.ok) {
            const errorData = await resp.json();
            throw new Error(errorData.detail || `Erro ${resp.status}`);
          }

          const data = await resp.json();

          if (data.applied) {
            applyBtn.textContent = "‚úÖ Aplicado!";
            setTimeout(() => {
              applyBtn.textContent = originalText;
              applyBtn.disabled = false;
            }, 2000);
          } else {
            throw new Error(data.message || "Falha ao aplicar pose");
          }
        } catch (e) {
          console.error(e);
          applyErr.textContent = `Erro ao aplicar: ${e.message}`;
          applyErr.style.display = "block";
          applyBtn.textContent = originalText;
          applyBtn.disabled = false;
        }
      }

      let serialConnected = false;

      // ========== Atualiza√ß√£o de Status ==========
      async function updateConnectionStatus() {
        try {
          const res = await fetch(`${API_BASE}/serial/status`);
          const status = await res.json();

          const indicator = document.getElementById("status-indicator");
          const text = document.getElementById("status-text");
          const portSpan = document.getElementById("status-port");

          if (status.connected && status.port) {
            indicator.className = "w-3 h-3 rounded-full bg-green-500 pulse-dot";
            text.textContent = "Conectado";
            portSpan.textContent = status.port;
          } else {
            indicator.className = "w-3 h-3 rounded-full bg-red-500";
            text.textContent = "Desconectado";
            portSpan.textContent = "--";
          }
        } catch (err) {
          console.error("Erro ao verificar status:", err);
        }
      }

      async function loadSerialPorts() {
        const sel = document.getElementById("serial-port-select");
        try {
          const resp = await fetch(`${API_BASE}/serial/ports`);
          if (!resp.ok)
            throw new Error(`Erro ${resp.status}: ${resp.statusText}`);
          const data = await resp.json();
          const ports = Array.isArray(data.ports) ? data.ports : [];
          sel.innerHTML = '<option value="">Selecione...</option>';
          ports.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p;
            sel.appendChild(opt);
          });
        } catch (e) {
          console.error("Erro ao listar portas:", e);
          sel.innerHTML = '<option value="">Erro ao carregar</option>';
        }
      }

      function setSerialStatus(connected, port = "") {
        serialConnected = connected;
        const indicator = document.getElementById("status-indicator");
        const text = document.getElementById("status-text");
        const portSpan = document.getElementById("status-port");
        const btnConnect = document.getElementById("btn-open-serial");
        const btnDisconnect = document.getElementById("btn-close-serial");

        if (connected) {
          indicator.className = "w-3 h-3 rounded-full bg-green-500 pulse-dot";
          text.textContent = "Conectado";
          portSpan.textContent = port;
          btnConnect.classList.add("hidden");
          btnDisconnect.classList.remove("hidden");
        } else {
          indicator.className = "w-3 h-3 rounded-full bg-red-500";
          text.textContent = "Desconectado";
          portSpan.textContent = "--";
          btnConnect.classList.remove("hidden");
          btnDisconnect.classList.add("hidden");
        }
      }

      async function openSerial() {
        const port = document.getElementById("serial-port-select").value;
        if (!port) {
          alert("Selecione uma porta serial");
          return;
        }
        try {
          const resp = await fetch(`${API_BASE}/serial/open`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ port, baud: 115200 }),
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data?.detail || `Erro ${resp.status}`);
          setSerialStatus(true, port);

          // Conecta ao WebSocket
          initTelemetryWS();
        } catch (e) {
          alert(`Erro ao conectar: ${e.message}`);
        }
      }

      async function closeSerial() {
        try {
          const resp = await fetch(`${API_BASE}/serial/close`, {
            method: "POST",
          });
          if (!resp.ok) throw new Error("Erro ao desconectar");
          setSerialStatus(false);

          // Fecha o WebSocket e cancela reconex√£o
          if (wsTimer) {
            clearTimeout(wsTimer);
            wsTimer = null;
          }
          if (ws) {
            ws.close();
            ws = null;
          }
        } catch (e) {
          alert(`Erro ao desconectar: ${e.message}`);
        }
      }

      //   function markLiveOnWS() {
      //     if (serialConnected) {
      //       const el = document.getElementById('serial-status');
      //       if (el && el.classList.contains('status-valid')) {
      //         el.textContent = el.textContent.replace('‚úÖ Conectado', '‚úÖ Conectado ‚Äî recebendo dados');
      //       }
      //     }
      //   }

      let ws = null,
        wsTimer = null;

      // Pontos fixos da base (mesmos do backend) - formato [x, y, z]
      const BASE_POINTS_FIXED = [
        [305.5, -17, 0],
        [305.5, 17, 0],
        [-137.7, 273.23, 0],
        [-168, 255.7, 0],
        [-167.2, -256.2, 0],
        [-136.8, -273.6, 0],
      ];

      function normalizeTelemetry(msg) {
        ////console.log('üîç normalizeTelemetry recebeu:', msg);

        const out = {};
        if (msg.pose) out.pose = msg.pose;

        // Base points - usa os fixos se n√£o vier no WebSocket
        if (msg.base_points) {
          out.base_points = msg.base_points;
          ////console.log('‚úÖ Usando base_points do WebSocket:', msg.base_points);
        } else if (msg.base_points_live) {
          out.base_points = msg.base_points_live;
          ////console.log('‚úÖ Usando base_points_live do WebSocket:', msg.base_points_live);
        } else {
          // Usa os pontos fixos da base como fallback
          out.base_points = BASE_POINTS_FIXED;
          ////console.log('‚ö†Ô∏è Usando BASE_POINTS_FIXED (fallback):', BASE_POINTS_FIXED);
        }

        // Platform points - PRIORIZA platform_points_live (do backend)
        if (msg.platform_points_live) {
          out.platform_points = msg.platform_points_live;
          ////console.log('‚úÖ Usando platform_points_live do backend:', msg.platform_points_live);
        } else if (msg.platform_points) {
          out.platform_points = msg.platform_points;
          ////console.log('‚úÖ Usando platform_points do WebSocket:', msg.platform_points);
        }

        if (typeof msg.valid === "boolean") out.valid = msg.valid;

        // Processa os atuadores
        if (msg.actuators) {
          out.actuators = msg.actuators.map((a, i) => ({
            id: a.id ?? i + 1,
            length: Number(a.length ?? 0),
            percentage: Number(a.percentage ?? 0),
            valid: Boolean(a.valid ?? true),
          }));
          ////console.log('‚úÖ Atuadores processados de msg.actuators');
        } else if (Array.isArray(msg.actuator_lengths_abs)) {
          out.actuators = msg.actuator_lengths_abs.map((L, i) => ({
            id: i + 1,
            length: Number(L),
            percentage: Array.isArray(msg.percentages)
              ? Number(msg.percentages[i] ?? 0)
              : 0,
            valid: true,
          }));
          ////console.log('‚úÖ Atuadores processados de actuator_lengths_abs');
        } else if (Array.isArray(msg.lengths)) {
          out.actuators = msg.lengths.map((L, i) => ({
            id: i + 1,
            length: Number(L),
            percentage: Array.isArray(msg.percentages)
              ? Number(msg.percentages[i] ?? 0)
              : 0,
            valid: true,
          }));
          ////console.log('‚úÖ Atuadores processados de lengths');
        }

        // Se temos comprimentos mas n√£o temos platform_points, tenta reconstruir
        if (out.actuators && !out.platform_points && out.base_points) {
          console.warn(
            "‚ö†Ô∏è platform_points n√£o veio do backend, reconstruindo localmente (menos preciso)"
          );
          out.platform_points = reconstructPlatformPoints(
            out.base_points,
            out.actuators
          );
        }

        ////console.log('üì§ normalizeTelemetry retorna:', out);
        return out;
      }

      // Fun√ß√£o para reconstruir os pontos da plataforma a partir dos comprimentos dos atuadores
      function reconstructPlatformPoints(basePoints, actuators) {
        // Se n√£o temos 6 atuadores v√°lidos, n√£o conseguimos reconstruir
        if (!actuators || actuators.length !== 6) return null;

        const platformPoints = [];

        // Para cada atuador, calcula a posi√ß√£o aproximada do ponto da plataforma
        for (let i = 0; i < 6; i++) {
          const base = basePoints[i];
          const length = actuators[i].length;

          // Ponto base em 3D (z=0 para a base)
          const bx = base[0];
          const by = base[1];
          const bz = 0;

          // Estimativa simples: assumindo movimento principalmente vertical
          // A plataforma sobe/desce mas mant√©m rela√ß√£o com a base
          const angle = Math.PI / 6; // √Çngulo aproximado dos atuadores
          const pz = length * Math.cos(angle); // Componente vertical
          const horizontalDist = length * Math.sin(angle); // Componente horizontal

          // Calcula dire√ß√£o da base para o centro (0,0)
          const dist = Math.sqrt(bx * bx + by * by);
          const dirX = -bx / dist;
          const dirY = -by / dist;

          // Ponto da plataforma (mais pr√≥ximo do centro)
          const px = bx + dirX * (dist - horizontalDist);
          const py = by + dirY * (dist - horizontalDist);

          platformPoints.push([px, py, pz]);
        }

        return platformPoints;
      }

      function applyLiveTelemetry(data) {
        if (
          data.base_points &&
          data.platform_points &&
          Array.isArray(data.actuators)
        ) {
          if (typeof data.valid !== "boolean") {
            data.valid = data.actuators.every((a) => a.valid !== false);
          }
          updateLiveMeasures(data.actuators);
          draw3DPlatform("canvas-live", data);
        } else if (Array.isArray(data.actuators)) {
          updateLiveMeasures(data.actuators);
          console.warn(
            "‚ö†Ô∏è WebSocket sem platform_points, aguardando dados completos..."
          );
        }
      }

      function initTelemetryWS() {
        if (ws) {
          try {
            ws.close();
          } catch (_) {}
          ws = null;
        }

        ////console.log('üîå Conectando WebSocket:', WS_URL);

        try {
          ws = new WebSocket(WS_URL);
        } catch (e) {
          console.error("‚ùå Erro ao criar WebSocket:", e);
          scheduleReconnect();
          return;
        }

        ws.onopen = () => {
          console.log('‚úÖ WebSocket conectado!');
          if (wsTimer) clearTimeout(wsTimer);
        };

        ws.onclose = () => {
          ////console.log('üîå WebSocket desconectado');
          scheduleReconnect();
        };

        ws.onerror = (e) => {
          console.error("‚ùå WebSocket error:", e);
        };

        ws.onmessage = (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            
            // Detectar eventos de motion_tick
            if (msg.type === "motion_tick" && msg.pose_cmd) {
              updateVisualizationFromMotion(msg.pose_cmd);
              
              // Atualizar timer do movimento em tempo real usando elapsed_ms
              if (msg.elapsed_ms !== undefined) {
                const elapsedSeconds = Math.floor(msg.elapsed_ms / 1000);
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                const elapsedEl = document.getElementById("motion-elapsed");
                if (elapsedEl) {
                  elapsedEl.textContent = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
                }
              }
              
              // Capturar dados para o gr√°fico de movimento
              if (msg.actuators_cmd) {
                // Se actuators_real vier como zeros, usar os valores da telemetria
                let actuators_real = msg.actuators_real || [];
                const allZeros = actuators_real.every(v => v === 0);
                
                if (allZeros && window.lastActuatorsReal) {
                  actuators_real = window.lastActuatorsReal;
                  console.log("üîÑ Usando valores da telemetria para actuators_real");
                }
                
                updateMotionGraph(
                  msg.elapsed_ms || 0,
                  msg.routine || "unknown",
                  msg.pose_cmd,
                  msg.actuators_cmd,
                  actuators_real
                );
              } else if (chartRecording) {
                console.warn("‚ö†Ô∏è motion_tick sem actuators_cmd:", msg);
              }
            } else {
              // Telemetria normal
              const data = normalizeTelemetry(msg);
              applyLiveTelemetry(data);
              // Os valores reais s√£o capturados em updateLiveMeasures()
            }
          } catch (e) {
            console.error("‚ùå Erro ao processar mensagem WS:", e, evt.data);
          }
        };
      }

      function scheduleReconnect() {
        if (wsTimer) clearTimeout(wsTimer);
        wsTimer = setTimeout(() => {
          if (serialConnected) {
            initTelemetryWS();
          }
        }, 1000);
      }

      async function checkExistingConnection() {
        ////console.log('üîç Verificando conex√£o existente...');

        try {
          // Verifica o status real no backend
          const res = await fetch(`${API_BASE}/serial/status`);
          const status = await res.json();

          ////console.log('üìä Status do backend:', status);

          if (status.connected && status.port) {
            // Backend est√° conectado
            serialConnected = true;
            setSerialStatus(true, status.port);

            // Preenche o select com a porta conectada
            const select = document.getElementById("serial-port-select");
            if (![...select.options].some((opt) => opt.value === status.port)) {
              const opt = document.createElement("option");
              opt.value = status.port;
              opt.textContent = status.port;
              opt.selected = true;
              select.appendChild(opt);
            } else {
              select.value = status.port;
            }

            ////console.log(`‚úÖ Reconectado √† sess√£o: ${status.port}`);

            // Reconecta ao WebSocket
            initTelemetryWS();
          } else {
            // Backend n√£o est√° conectado
            ////console.log('‚ùå Backend n√£o est√° conectado');
          }
          
          // Verificar se h√° movimento rodando
          await checkMotionStatus();
        } catch (err) {
          console.error("‚ö†Ô∏è Erro ao verificar status:", err);
        }
      }
      
      async function checkMotionStatus() {
        try {
          const res = await fetch(`${API_BASE}/motion/status`);
          const data = await res.json();
          
          if (data.running) {
            console.log(`üîÑ Movimento detectado rodando: ${data.routine || 'unknown'} (${data.elapsed?.toFixed(1) || 0}s)`);
            // Atualizar UI para refletir que h√° movimento rodando
            const btnStart = document.getElementById("btn-start-motion");
            const btnStop = document.getElementById("btn-stop-motion");
            const statusEl = document.querySelector("#motion-routines-section .flex.items-center.gap-2");
            
            if (btnStart) btnStart.disabled = true;
            if (btnStop) btnStop.disabled = false;
            
            // Atualizar o indicador visual (bolinha verde "Rodando")
            if (statusEl) {
              const dot = statusEl.querySelector(".w-2.h-2");
              const text = statusEl.querySelector("span");
              const timer = statusEl.querySelector(".text-sm");
              
              if (dot) {
                dot.classList.remove("bg-gray-400");
                dot.classList.add("bg-green-500");
              }
              if (text) {
                text.textContent = "Rodando";
              }
              if (timer) {
                timer.textContent = `${data.elapsed?.toFixed(0) || 0}s`;
              }
            }
            
            // Se estava com gr√°fico gravando antes do F5, pode ter perdido o estado
            console.warn("‚ö†Ô∏è Aten√ß√£o: Movimento estava rodando antes do reload. Verifique o estado do gr√°fico.");
          }
        } catch (err) {
          // Endpoint existe mas pode dar erro se backend ainda n√£o iniciou
          console.log("‚ÑπÔ∏è N√£o foi poss√≠vel verificar status do movimento");
        }
      }

      // Atualizar visualiza√ß√£o 3D a partir de pose do motion routine
      let motionUpdatePending = false;
      let lastMotionPose = null;

      async function updateVisualizationFromMotion(pose_cmd) {
        // Guardar a √∫ltima pose recebida
        lastMotionPose = pose_cmd;

        // Se j√° tem uma atualiza√ß√£o pendente, skip (throttle)
        if (motionUpdatePending) {
          return;
        }

        motionUpdatePending = true;

        try {
          // Calcular cinem√°tica inversa para a pose
          const response = await fetch(`${API_BASE}/calculate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(lastMotionPose),
          });

          if (!response.ok) {
            console.warn(
              "‚ö†Ô∏è Falha ao calcular IK para motion:",
              lastMotionPose
            );
            motionUpdatePending = false;
            return;
          }

          const calcData = await response.json();

          // Atualizar APENAS Preview (simulado) - Live √© atualizado pela telemetria real
          if (
            calcData.base_points &&
            calcData.platform_points &&
            calcData.actuators
          ) {
            draw3DPlatform("canvas-preview", calcData);
          }
        } catch (error) {
          console.error("‚ùå Erro ao atualizar visualiza√ß√£o de motion:", error);
        } finally {
          // Libera ap√≥s um pequeno delay para throttle (m√°ximo ~30 FPS)
          setTimeout(() => {
            motionUpdatePending = false;
          }, 33);
        }
      }

      // ========== IndexedDB para Gr√°fico de Movimento ==========
      function initMotionDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(MOTION_DB_NAME, MOTION_DB_VERSION);
          
          request.onerror = () => reject(request.error);
          
          request.onsuccess = () => {
            motionDB = request.result;
            console.log("‚úÖ MotionDB inicializado");
            resolve(motionDB);
          };
          
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(MOTION_STORE_NAME)) {
              const objectStore = db.createObjectStore(MOTION_STORE_NAME, {
                keyPath: "id",
                autoIncrement: true,
              });
              objectStore.createIndex("timestamp", "timestamp", { unique: false });
              console.log("‚úÖ ObjectStore motion_data criado");
            }
          };
        });
      }

      let saveAttempts = 0;
      let saveSuccesses = 0;
      
      async function saveMotionDataToDB(data) {
        if (!motionDB || !chartRecording) return;
        
        saveAttempts++;
        
        return new Promise((resolve, reject) => {
          try {
            const transaction = motionDB.transaction([MOTION_STORE_NAME], "readwrite");
            const store = transaction.objectStore(MOTION_STORE_NAME);
            
            // Handlers da transa√ß√£o
            transaction.oncomplete = () => {
              saveSuccesses++;
              if (saveSuccesses % 10 === 0) {
                console.log(`üíæ IndexedDB: ${saveSuccesses} registros salvos (transa√ß√£o completa)`);
              }
              resolve();
            };
            
            transaction.onerror = () => {
              console.error("‚ùå Erro na transa√ß√£o:", transaction.error);
              reject(transaction.error);
            };
            
            transaction.onabort = () => {
              console.error("‚ùå Transa√ß√£o abortada:", transaction.error);
              reject(new Error("Transa√ß√£o abortada"));
            };
            
            const request = store.add(data);
            
            request.onerror = () => {
              console.error("‚ùå Erro no add():", request.error);
              console.error("   Dados:", data);
            };
          } catch (error) {
            console.error("‚ùå Exce√ß√£o em saveMotionDataToDB:", error);
            reject(error);
          }
        });
      }

      async function getAllMotionDataFromDB() {
        if (!motionDB) return [];
        
        return new Promise((resolve, reject) => {
          const transaction = motionDB.transaction([MOTION_STORE_NAME], "readonly");
          const store = transaction.objectStore(MOTION_STORE_NAME);
          const request = store.getAll();
          
          request.onsuccess = () => {
            console.log(`üìä getAllMotionDataFromDB: ${request.result.length} registros`);
            resolve(request.result);
          };
          request.onerror = () => reject(request.error);
        });
      }

      async function clearMotionDataFromDB() {
        if (!motionDB) return;
        
        return new Promise((resolve, reject) => {
          const transaction = motionDB.transaction([MOTION_STORE_NAME], "readwrite");
          const store = transaction.objectStore(MOTION_STORE_NAME);
          const request = store.clear();
          
          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }

      // Fun√ß√£o de debug global (use no console: debugMotionDB())
      window.debugMotionDB = async function() {
        console.log("üîç DEBUG - Estado do MotionDB:");
        console.log(`   motionDB: ${motionDB ? 'OK' : 'N√ÉO INICIALIZADO'}`);
        console.log(`   chartRecording: ${chartRecording}`);
        console.log(`   motionChart: ${motionChart ? 'OK' : 'N√ÉO INICIALIZADO'}`);
        console.log(`   motionChartData.length: ${motionChartData.length}`);
        console.log(`   saveAttempts: ${saveAttempts}`);
        console.log(`   saveSuccesses: ${saveSuccesses}`);
        
        if (motionDB) {
          try {
            const data = await getAllMotionDataFromDB();
            console.log(`   üìä Registros no IndexedDB: ${data.length}`);
            if (data.length > 0) {
              console.log("   Amostra (primeiro registro):", data[0]);
              console.log("   Amostra (√∫ltimo registro):", data[data.length - 1]);
            } else {
              console.warn("   ‚ö†Ô∏è IndexedDB est√° vazio!");
            }
          } catch (error) {
            console.error("   ‚ùå Erro ao buscar dados:", error);
          }
        } else {
          console.error("   ‚ùå motionDB n√£o foi inicializado - verifique se initMotionDB() foi chamado");
        }
      };
      
      // Fun√ß√£o de teste - for√ßar grava√ß√£o de um registro teste
      window.testSaveMotionDB = async function() {
        console.log("üß™ TESTE: Tentando salvar registro teste...");
        
        if (!motionDB) {
          console.error("‚ùå motionDB n√£o inicializado");
          return;
        }
        
        const testData = {
          timestamp: Date.now(),
          routine: "test",
          pose: { x: 0, y: 0, z: 500, roll: 0, pitch: 0, yaw: 0 },
          commanded: [100, 100, 100, 100, 100, 100],
          actual: [100, 100, 100, 100, 100, 100]
        };
        
        return new Promise((resolve, reject) => {
          const transaction = motionDB.transaction([MOTION_STORE_NAME], "readwrite");
          const store = transaction.objectStore(MOTION_STORE_NAME);
          
          transaction.oncomplete = () => {
            console.log("‚úÖ Transa√ß√£o completa - verificando...");
            getAllMotionDataFromDB().then(data => {
              console.log(`   Total de registros agora: ${data.length}`);
              if (data.length > 0) {
                console.log("   √öltimo registro:", data[data.length - 1]);
              }
            });
            resolve();
          };
          
          transaction.onerror = () => {
            console.error("‚ùå Erro na transa√ß√£o:", transaction.error);
            reject(transaction.error);
          };
          
          const request = store.add(testData);
          
          request.onsuccess = () => {
            console.log("‚úÖ add() bem-sucedido, key:", request.result);
          };
          
          request.onerror = () => {
            console.error("‚ùå Erro no add():", request.error);
          };
        });
      };

      // ========== Fun√ß√µes do Gr√°fico de Movimento ==========
      async function toggleMotionChart() {
        const section = document.getElementById("motion-chart-section");
        const btn = document.getElementById("btn-toggle-motion-chart");
        
        motionChartVisible = !motionChartVisible;
        
        if (motionChartVisible) {
          section.classList.remove("hidden");
          btn.textContent = "üìä Esconder Gr√°fico";
          if (!motionChart) {
            initMotionChart();
          }
        } else {
          section.classList.add("hidden");
          btn.textContent = "üìä Mostrar Gr√°fico";
        }
      }

      function initMotionChart() {
        console.log('üìà Inicializando motionChart...');
        const ctx = document.getElementById("motion-chart").getContext("2d");
        
        motionChart = new Chart(ctx, {
          type: "line",
          data: {
            datasets: [
              // Comandados (setpoints) - linhas tracejadas
              { label: "P1 CMD", borderColor: "#ef4444", borderDash: [5, 5], borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P2 CMD", borderColor: "#f59e0b", borderDash: [5, 5], borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P3 CMD", borderColor: "#eab308", borderDash: [5, 5], borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P4 CMD", borderColor: "#22c55e", borderDash: [5, 5], borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P5 CMD", borderColor: "#3b82f6", borderDash: [5, 5], borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P6 CMD", borderColor: "#a855f7", borderDash: [5, 5], borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              // Reais (atuadores) - linhas s√≥lidas
              { label: "P1 Real", borderColor: "#ef4444", borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P2 Real", borderColor: "#f59e0b", borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P3 Real", borderColor: "#eab308", borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P4 Real", borderColor: "#22c55e", borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P5 Real", borderColor: "#3b82f6", borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
              { label: "P6 Real", borderColor: "#a855f7", borderWidth: 2, fill: false, data: [], tension: 0.4, pointRadius: 0 },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            parsing: false,
            normalized: true,
            scales: {
              x: {
                type: "linear",
                title: { display: true, text: "Tempo (s)", color: "#9ca3af" },
                ticks: { color: "#9ca3af" },
                grid: { color: "#374151" },
              },
              y: {
                title: { display: true, text: "Posi√ß√£o (mm)", color: "#9ca3af" },
                ticks: { color: "#9ca3af" },
                grid: { color: "#374151" },
              },
            },
            plugins: {
              legend: {
                labels: { color: "#9ca3af", font: { size: 10 } },
                position: "top",
              },
              zoom: {
                pan: { enabled: true, mode: "xy" },
                zoom: {
                  wheel: { enabled: true },
                  pinch: { enabled: true },
                  mode: "xy",
                },
              },
            },
          },
        });
        
        console.log("‚úÖ Gr√°fico de movimento inicializado");
        console.log(`   Total de datasets: ${motionChart.data.datasets.length}`);
        console.log(`   Datasets 0-5: CMD (tracejadas)`);
        console.log(`   Datasets 6-11: Real (s√≥lidas)`);
      }

      function startMotionChart() {
        console.log("‚ñ∂Ô∏è startMotionChart() - Iniciando grava√ß√£o...");
        
        chartRecording = true;
        motionChartData = [];
        motionStartTimestamp = null; // Reset timestamp
        
        console.log("üóëÔ∏è Limpando dados antigos do IndexedDB...");
        clearMotionDataFromDB()
          .then(() => console.log("‚úÖ IndexedDB limpo com sucesso"))
          .catch(error => console.error("‚ùå Erro ao limpar IndexedDB:", error));
        
        document.getElementById("btn-start-motion-chart").classList.add("hidden");
        document.getElementById("btn-stop-motion-chart").classList.remove("hidden");
        document.getElementById("motion-chart-status").textContent = 
          `üî¥ Gravando... (janela de ${CHART_WINDOW_SECONDS}s)`;
        
        console.log(`‚úÖ Grava√ß√£o ATIVADA (chartRecording = ${chartRecording})`);
        console.log(`   - motionDB: ${motionDB ? 'OK' : 'N√ÉO INICIALIZADO'}`);
        console.log(`   - motionChart: ${motionChart ? 'OK' : 'N√ÉO INICIALIZADO'}`);
        console.log("üí° Aguardando dados de updateMotionGraph()...");
      }

      function stopMotionChart() {
        console.log("üõë stopMotionChart() chamado");
        console.log(`   chartRecording antes: ${chartRecording}`);
        
        chartRecording = false;
        
        console.log(`   chartRecording depois: ${chartRecording}`);
        console.log(`   Pontos gravados: ${motionChartData.length}`);
        
        const btnStart = document.getElementById("btn-start-motion-chart");
        const btnStop = document.getElementById("btn-stop-motion-chart");
        
        if (!btnStart || !btnStop) {
          console.error("‚ùå Bot√µes n√£o encontrados!");
          return;
        }
        
        btnStart.classList.remove("hidden");
        btnStop.classList.add("hidden");
        
        document.getElementById("motion-chart-status").textContent = 
          `‚è∏ Pausado (${motionChartData.length} pontos gravados)`;
        
        console.log("‚úÖ Gr√°fico pausado com sucesso");
      }

      function resetMotionChartZoom() {
        if (!motionChart) return;
        motionChart.resetZoom();
        console.log("üîç Zoom resetado");
      }

      function toggleMotionPistonVisibility(pistonNum) {
        if (!motionChart) {
          console.warn("‚ö†Ô∏è motionChart n√£o inicializado");
          return;
        }
        
        const checkbox = document.getElementById(`motion-piston-${pistonNum}-visible`);
        if (!checkbox) {
          console.error(`‚ùå Checkbox motion-piston-${pistonNum}-visible n√£o encontrado`);
          return;
        }
        
        const isVisible = checkbox.checked;
        
        // Os datasets est√£o organizados: CMD 0-5, Real 6-11
        // Para pist√£o N:
        // - CMD est√° no √≠ndice: (N-1)
        // - Real est√° no √≠ndice: (N-1) + 6
        const cmdIndex = pistonNum - 1;
        const realIndex = pistonNum - 1 + 6;
        
        console.log(`üîç Pist√£o ${pistonNum}: checkbox.checked=${checkbox.checked}, isVisible=${isVisible}`);
        console.log(`   CMD index: ${cmdIndex}, Real index: ${realIndex}`);
        console.log(`   Total datasets: ${motionChart.data.datasets.length}`);
        
        if (!motionChart.data.datasets[cmdIndex]) {
          console.error(`‚ùå Dataset CMD n√£o encontrado no √≠ndice ${cmdIndex}`);
          return;
        }
        if (!motionChart.data.datasets[realIndex]) {
          console.error(`‚ùå Dataset Real n√£o encontrado no √≠ndice ${realIndex}`);
          return;
        }
        
        // Ocultar/mostrar datasets
        motionChart.data.datasets[cmdIndex].hidden = !isVisible;
        motionChart.data.datasets[realIndex].hidden = !isVisible;
        
        console.log(`   Dataset[${cmdIndex}].hidden = ${motionChart.data.datasets[cmdIndex].hidden}`);
        console.log(`   Dataset[${realIndex}].hidden = ${motionChart.data.datasets[realIndex].hidden}`);
        
        motionChart.update();
        
        console.log(`‚úÖ Pist√£o ${pistonNum}: ${isVisible ? "vis√≠vel" : "oculto"}`);
      }

      function toggleAllMotionPistons(visible) {
        for (let i = 1; i <= 6; i++) {
          const checkbox = document.getElementById(`motion-piston-${i}-visible`);
          if (checkbox) {
            checkbox.checked = visible;
            toggleMotionPistonVisibility(i);
          }
        }
      }

      function toggleMotionPistonsByType(type) {
        if (!motionChart) {
          console.warn("‚ö†Ô∏è motionChart n√£o inicializado");
          return;
        }
        
        for (let i = 1; i <= 6; i++) {
          const checkbox = document.getElementById(`motion-piston-${i}-visible`);
          if (!checkbox) continue;
          
          const cmdIndex = i - 1;
          const realIndex = i - 1 + 6;
          
          if (type === 'cmd') {
            // Mostrar apenas comandados (tracejados)
            checkbox.checked = true;
            motionChart.data.datasets[cmdIndex].hidden = false;
            motionChart.data.datasets[realIndex].hidden = true;
          } else if (type === 'real') {
            // Mostrar apenas reais (s√≥lidos)
            checkbox.checked = true;
            motionChart.data.datasets[cmdIndex].hidden = true;
            motionChart.data.datasets[realIndex].hidden = false;
          }
        }
        
        motionChart.update();
        console.log(`‚úÖ Filtro aplicado: ${type === 'cmd' ? 'Apenas Comandados' : 'Apenas Reais'}`);
      }

      function clearMotionChart() {
        chartRecording = false;
        motionChartData = [];
        saveAttempts = 0;
        saveSuccesses = 0;
        clearMotionDataFromDB();
        
        if (motionChart) {
          motionChart.data.datasets.forEach(dataset => {
            dataset.data = [];
          });
          motionChart.update("none");
          motionChart.resetZoom();
        }
        
        document.getElementById("btn-start-motion-chart").classList.remove("hidden");
        document.getElementById("btn-stop-motion-chart").classList.add("hidden");
        document.getElementById("motion-chart-status").textContent = 
          "Pronto para iniciar grava√ß√£o";
        
        console.log("üóëÔ∏è Gr√°fico limpo");
      }

      async function exportMotionToCSV() {
        try {
          const allData = await getAllMotionDataFromDB();
          
          if (allData.length === 0) {
            alert("‚ö†Ô∏è Nenhum dado de movimento para exportar!");
            return;
          }
          
          // Cabe√ßalho CSV
          let csvContent = "Timestamp,Routine,X_cmd,Y_cmd,Z_cmd,Roll_cmd,Pitch_cmd,Yaw_cmd," +
                          "P1_cmd,P2_cmd,P3_cmd,P4_cmd,P5_cmd,P6_cmd," +
                          "P1_real,P2_real,P3_real,P4_real,P5_real,P6_real\n";
          
          // Dados
          allData.forEach(row => {
            const timestamp = new Date(row.timestamp).toISOString();
            const routine = row.routine || "unknown";
            const pose = row.pose || {};
            const cmd = row.commanded || [];
            const real = row.actual || [];
            
            csvContent += `${timestamp},${routine},` +
                         `${pose.x || 0},${pose.y || 0},${pose.z || 0},` +
                         `${pose.roll || 0},${pose.pitch || 0},${pose.yaw || 0},` +
                         `${cmd.join(",")},${real.join(",")}\n`;
          });
          
          // Download
          const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          const filename = `motion_trajectory_${new Date().toISOString().replace(/[:.]/g, "-")}.csv`;
          
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.display = "none";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          console.log(`‚úÖ CSV exportado: ${allData.length} registros`);
        } catch (error) {
          console.error("‚ùå Erro ao exportar CSV:", error);
          alert(`Erro ao exportar CSV: ${error.message}`);
        }
      }

      function startMotionGraph() {
        // N√ÉO inicia automaticamente - usu√°rio controla manualmente
        console.log("‚ÑπÔ∏è Movimento iniciado (gr√°fico n√£o inicia automaticamente)");
      }

      function stopMotionGraph() {
        // N√ÉO para automaticamente - usu√°rio controla manualmente
        console.log("‚ÑπÔ∏è Movimento parado (gr√°fico continua se estiver gravando)");
      }

      function updateMotionGraph(timestamp, routine, pose, commandedLengths, actualLengths) {
        // S√≥ processa se estiver gravando
        if (!chartRecording) {
          // console.log("‚è≠Ô∏è updateMotionGraph: pulando (n√£o est√° gravando)");
          return;
        }
        
        if (!motionChart) {
          console.warn("‚ö†Ô∏è updateMotionGraph: motionChart n√£o inicializado");
          return;
        }
        
        const now = Date.now();
        
        // Inicializar timestamp de refer√™ncia no primeiro dado
        if (motionStartTimestamp === null) {
          motionStartTimestamp = now;
          console.log(`üé¨ Primeira captura de dados no gr√°fico (t=${timestamp.toFixed(3)}s)`);
          console.log(`   commanded (CMD): [${commandedLengths.map(v => v.toFixed(1)).join(", ")}]`);
          console.log(`   actual (Real): [${actualLengths.map(v => v.toFixed(1)).join(", ")}]`);
        }
        
        // DEBUG: Log peri√≥dico dos valores reais
        if (Math.floor(timestamp / 1000) % 5 === 0 && timestamp % 1000 < 100) {
          const allZeros = actualLengths.every(v => v === 0);
          if (allZeros) {
            console.warn(`‚ö†Ô∏è actuators_real est√° TODO ZERO em t=${timestamp.toFixed(1)}ms`);
          }
        }
        
        const timeInSeconds = timestamp / 1000.0;
        
        // Adiciona aos dados em mem√≥ria
        const dataPoint = {
          timestamp: now,
          routine: routine,
          pose: pose,
          commanded: commandedLengths,
          actual: actualLengths,
        };
        
        motionChartData.push(dataPoint);
        
        // Log a cada 50 pontos para n√£o poluir o console
        if (motionChartData.length % 50 === 0) {
          console.log(`üìä Capturados ${motionChartData.length} pontos`);
        }
        
        // Salva no IndexedDB (sem limite)
        saveMotionDataToDB(dataPoint).catch(err => 
          console.error("‚ùå Erro ao salvar no DB:", err)
        );
        
        // Atualizar datasets comandados (0-5)
        commandedLengths.forEach((length, i) => {
          if (motionChart.data.datasets[i]) {
            motionChart.data.datasets[i].data.push({ x: timeInSeconds, y: length });
          }
        });
        
        // Atualizar datasets reais (6-11)
        actualLengths.forEach((length, i) => {
          if (motionChart.data.datasets[i + 6]) {
            motionChart.data.datasets[i + 6].data.push({ x: timeInSeconds, y: length });
          }
        });
        
        // Limita pontos no gr√°fico para performance (janela deslizante)
        if (motionChartData.length > maxDataPoints) {
          motionChartData.shift();
        }
        
        // Remove pontos antigos do gr√°fico (mant√©m janela de CHART_WINDOW_SECONDS)
        const windowStart = timeInSeconds - CHART_WINDOW_SECONDS;
        motionChart.data.datasets.forEach(dataset => {
          while (dataset.data.length > 0 && dataset.data[0].x < windowStart) {
            dataset.data.shift();
          }
        });
        
        // Atualizar gr√°fico (sem anima√ß√£o para melhor performance)
        motionChart.update("none");
        
        // Atualiza status com contagem
        document.getElementById("motion-chart-status").textContent = 
          `üî¥ Gravando... (${motionChartData.length} pontos em mem√≥ria, janela de ${CHART_WINDOW_SECONDS}s)`;
      }

      window.addEventListener("DOMContentLoaded", async () => {
        setupInputSync();
        init3D("canvas-preview");
        init3D("canvas-live");
        await loadSerialPorts();
        await checkExistingConnection();
        
        // Inicializar IndexedDB para gr√°fico de movimento
        try {
          await initMotionDB();
          console.log("‚úÖ MotionDB pronto");
        } catch (error) {
          console.error("‚ùå Erro ao inicializar MotionDB:", error);
        }
        document
          .getElementById("btn-refresh-ports")
          .addEventListener("click", loadSerialPorts);
        document
          .getElementById("btn-open-serial")
          .addEventListener("click", openSerial);
        document
          .getElementById("btn-close-serial")
          .addEventListener("click", closeSerial);
        document
          .getElementById("btn-calc")
          .addEventListener("click", calculatePosition);
        document
          .getElementById("btn-reset")
          .addEventListener("click", resetPosition);
        document
          .getElementById("btn-apply")
          .addEventListener("click", applyToBench);
        document
          .getElementById("btn-reset-cam-prev")
          .addEventListener("click", () => resetCamera("canvas-preview"));
        document
          .getElementById("btn-reset-cam-live")
          .addEventListener("click", () => resetCamera("canvas-live"));
        calculatePosition();

        // Atualiza status periodicamente
        setInterval(updateConnectionStatus, 2000);
      });

      // ============ MOTION ROUTINES ============
      const MOTION_PRESET_CONFIG = {
        sine_z: {
          routine: "sine_axis",
          axis: "z",
          defaultParams: ["amp", "hz", "duration_s"],
        },
        circle_xy: {
          routine: "circle_xy",
          defaultParams: ["ax", "ay", "hz", "duration_s"],
        },
        heave_pitch: {
          routine: "heave_pitch",
          defaultParams: ["amp", "ay", "hz", "duration_s"],
        },
        sine_pitch: {
          routine: "sine_axis",
          axis: "pitch",
          defaultParams: ["amp", "hz", "duration_s"],
        },
        sine_roll: {
          routine: "sine_axis",
          axis: "roll",
          defaultParams: ["amp", "hz", "duration_s"],
        },
        helix: {
          routine: "helix",
          defaultParams: ["ax", "ay", "z_amp_mm", "z_cycles", "hz", "duration_s"],
        },
      };

      let motionStatusInterval = null;
      // Timer agora vem direto do WebSocket motion_tick (elapsed_ms)

      // Iniciar preset
      document.querySelectorAll(".btn-start-motion").forEach((btn) => {
        btn.addEventListener("click", async function () {
          const card = this.closest(".motion-preset-card");
          const presetKey = card.dataset.preset;
          const config = MOTION_PRESET_CONFIG[presetKey];

          const payload = { routine: config.routine };
          if (config.axis) payload.axis = config.axis;

          config.defaultParams.forEach((param) => {
            const input = card.querySelector(`[data-param="${param}"]`);
            if (input) payload[param] = parseFloat(input.value);
          });

          if (config.extraDefaults)
            Object.assign(payload, config.extraDefaults);

          try {
            // Atualizar UI imediatamente para "Indo para HOME..."
            const statusDot = document.getElementById("motion-status-dot");
            const statusText = document.getElementById("motion-status-text");
            const elapsedText = document.getElementById("motion-elapsed");
            
            statusDot.className = "w-3 h-3 rounded-full bg-yellow-500 pulse-dot";
            statusText.textContent = "Indo para HOME...";
            elapsedText.textContent = "00:00";
            
            const response = await fetch(`${API_BASE}/motion/start`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const data = await response.json();

            if (response.ok) {
              ////console.log('‚úÖ Rotina iniciada:', data);
              card.classList.add("active");
              
              // Aguardar 1.5s (tempo de ir para HOME + calibra√ß√£o)
              setTimeout(() => {
                statusText.textContent = "Rodando";
                statusDot.className = "w-3 h-3 rounded-full motion-status-running";
                startMotionMonitoring();
              }, 1500);
            } else {
              // Voltar ao estado parado em caso de erro
              statusDot.className = "w-3 h-3 rounded-full motion-status-stopped";
              statusText.textContent = "Parado";
              alert(`Erro: ${data.detail || "Falha ao iniciar rotina"}`);
            }
          } catch (error) {
            // Voltar ao estado parado em caso de erro
            const statusDot = document.getElementById("motion-status-dot");
            const statusText = document.getElementById("motion-status-text");
            statusDot.className = "w-3 h-3 rounded-full motion-status-stopped";
            statusText.textContent = "Parado";
            alert(`Erro de conex√£o: ${error.message}`);
          }
        });
      });

      // Parar rotina
      document
        .getElementById("btn-motion-stop")
        .addEventListener("click", async function () {
          try {
            const response = await fetch(`${API_BASE}/motion/stop`, {
              method: "POST",
            });
            if (response.ok) {
              ////console.log('‚èπÔ∏è Rotina parada');
              stopMotionMonitoring();
              updateMotionUIState(false);
            } else {
              alert("Erro ao parar rotina");
            }
          } catch (error) {
            alert(`Erro: ${error.message}`);
          }
        });

      function startMotionMonitoring() {
        if (motionStatusInterval) return;
        motionStatusInterval = setInterval(checkMotionStatus, 500);
        // Timer agora √© atualizado pelo WebSocket motion_tick (mais preciso)
      }

      function stopMotionMonitoring() {
        if (motionStatusInterval) {
          clearInterval(motionStatusInterval);
          motionStatusInterval = null;
        }
      }

      async function checkMotionStatus() {
        try {
          const response = await fetch(`${API_BASE}/motion/status`);
          const status = await response.json();

          if (status.running) {
            updateMotionUIState(true, status);
          } else {
            updateMotionUIState(false);
            stopMotionMonitoring();
          }
        } catch (error) {
          console.error("Erro ao verificar status da rotina:", error);
        }
      }

      function updateMotionUIState(running, status = null) {
        const statusDot = document.getElementById("motion-status-dot");
        const statusText = document.getElementById("motion-status-text");
        const btnStop = document.getElementById("btn-motion-stop");
        const btnApply = document.getElementById("btn-apply");
        const btnToggleChart = document.getElementById("btn-toggle-motion-chart");

        // Remover active de todos os cards
        document.querySelectorAll(".motion-preset-card").forEach((card) => {
          card.classList.remove("active");
        });

        if (running && status) {
          statusDot.className = "w-3 h-3 rounded-full motion-status-running";
          statusText.textContent = "Rodando";
          btnStop.disabled = false;
          
          // Desabilitar bot√£o "Aplicar na Bancada" durante movimento
          if (btnApply) {
            btnApply.disabled = true;
            btnApply.style.opacity = "0.5";
            btnApply.style.cursor = "not-allowed";
          }
          
          // Mostrar bot√£o de toggle do gr√°fico
          if (btnToggleChart) {
            btnToggleChart.classList.remove("hidden");
          }
          
          // Iniciar captura do gr√°fico
          startMotionGraph();

          // Ativar card correspondente
          const presetKey = findMotionPresetKey(status.routine, status.params);
          if (presetKey) {
            const card = document.querySelector(`[data-preset="${presetKey}"]`);
            if (card) card.classList.add("active");
          }
        } else {
          statusDot.className = "w-3 h-3 rounded-full motion-status-stopped";
          statusText.textContent = "Parado";
          btnStop.disabled = true;
          document.getElementById("motion-elapsed").textContent = "00:00";
          
          // Reabilitar bot√£o "Aplicar na Bancada" quando parar
          if (btnApply) {
            btnApply.disabled = false;
            btnApply.style.opacity = "1";
            btnApply.style.cursor = "pointer";
          }
          
          // N√ÉO esconder bot√£o de toggle se o gr√°fico estiver aberto
          // S√≥ esconde se o gr√°fico n√£o estiver vis√≠vel
          if (btnToggleChart && !motionChartVisible) {
            btnToggleChart.classList.add("hidden");
          }
          
          // Finalizar captura do gr√°fico
          stopMotionGraph();
        }
      }

      function findMotionPresetKey(routine, params) {
        for (const [key, config] of Object.entries(MOTION_PRESET_CONFIG)) {
          if (config.routine === routine) {
            if (routine === "sine_axis" && config.axis === params?.axis) {
              return key;
            } else if (routine !== "sine_axis") {
              return key;
            }
          }
        }
        return null;
      }
    </script>
  </body>
</html>
